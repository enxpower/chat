rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() { return request.auth != null; }

    // ========== 公聊 ==========
    match /messages/{id} {
      allow read: if true;        // 想更严可以改 isAuth()
      allow create: if isAuth();  // 匿名可发
    }

    // ========== 私聊（基于 TID 权限）==========
    // 约定：tid = smallerUID + '_' + largerUID
    function inTid(tid) {
      return isAuth() &&
        (tid.matches('^' + request.auth.uid + '_.*') ||
         tid.matches('.*_' + request.auth.uid + '$'));
    }

    match /dmThreads/{tid} {
      // 随便创建，不做字段校验（避免“写之前先读”的阻碍）
      allow create: if isAuth();
      // 只有 TID 含自己 UID 的人能读线程
      allow read:   if inTid(tid);

      match /messages/{mid} {
        // 只有 TID 含自己 UID 的人能读/发该线程消息
        allow read, create: if inTid(tid);
      }
    }
  }
}
