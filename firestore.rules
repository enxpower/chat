rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() { return request.auth != null; }

    function isAdmin() {
      return isAuth() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             ("roles" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data) &&
             ("admin" in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles);
    }

    match /users/{uid} {
      allow read: if isAuth();
      allow create, update: if isAuth() && request.auth.uid == uid;
      allow delete: if false;
    }

    match /nicknames/{name} {
      allow read: if true;
      allow create: if isAuth() && !exists(resource.path);
      allow update, delete: if false;
    }

    match /messages/{id} {
      allow read: if true;
      allow create: if isAuth();
      allow update, delete: if false;
    }

    // 私聊：单层集合 /dm，文档需含 parties: [uidA, uidB]
    match /dm/{mid} {
      allow read: if isAuth() &&
                  ((request.auth.uid in resource.data.parties) || isAdmin());

      allow create: if isAuth()
        && (request.resource.data.parties is list)
        && request.resource.data.parties.size() == 2
        && request.resource.data.parties[0] != request.resource.data.parties[1]
        && (request.auth.uid in request.resource.data.parties);

      allow update, delete: if false;
    }
  }
}
