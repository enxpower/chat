rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() { return request.auth != null; }

    // ===== 用户档案（可选）=====
    match /users/{uid} {
      allow read: if isAuth();
      allow create, update: if isAuth() && request.auth.uid == uid;
      allow delete: if false;
    }

    // ===== 昵称占用表（全局唯一）=====
    match /nicknames/{name} {
      allow read: if true;
      allow create: if isAuth() && !exists(resource.path);
      allow update, delete: if false;
    }

    // ===== 公聊消息 =====
    match /messages/{msgId} {
      allow read: if true;       // 或改 isAuth()
      allow create: if isAuth(); // 匿名即可发
      allow update, delete: if false;
    }

    // ===== 私聊线程（仅参与者可读写）=====
    match /dmThreads/{tid} {
      // 创建时即校验 participants
      allow create: if isAuth()
                    && (request.resource.data.participants is list)
                    && request.resource.data.participants.size() == 2
                    && request.auth.uid in request.resource.data.participants;

      // 读取线程文档：必须是参与者
      allow read: if isAuth()
                  && (request.auth.uid in resource.data.participants);

      // 线程下的消息：必须是参与者
      match /messages/{mid} {
        allow read, create: if isAuth()
          && (request.auth.uid in
              get(/databases/$(database)/documents/dmThreads/$(tid)).data.participants);
        allow update, delete: if false;
      }
    }
  }
}
