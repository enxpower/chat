<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸­æ–‡èŠå¤©å®¤ Â· å•æˆ¿é—´</title>
  <style>
    :root{--box:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,sans-serif;margin:16px}
    h1{font-size:18px;margin:0 0 8px}
    .row{display:flex;gap:12px}
    .sidebar{width:280px;border:1px solid var(--box);border-radius:12px;padding:12px}
    .main{flex:1;border:1px solid var(--box);border-radius:12px;padding:12px;display:flex;flex-direction:column;height:85vh}
    .hint{color:var(--muted);margin-bottom:8px}
    .msgs{flex:1;overflow:auto;border:1px solid var(--box);border-radius:10px;padding:8px;background:#fafafa}
    .msg{margin:8px 0;line-height:1.45}
    .nick{font-weight:600;cursor:pointer}
    .male{color:#1d4ed8}.female{color:#d946ef}.unset{color:#6b7280}
    .dim{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:12px;align-items:center;margin:8px 0}
    textarea{flex:1;resize:vertical;min-height:46px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--box);border-radius:999px;margin:4px 6px 0 0;cursor:pointer}
    .btn{border:1px solid var(--box);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    input[type="text"], select{width:100%;padding:6px 8px;border:1px solid var(--box);border-radius:8px}
    label{font-size:12px;color:#555}
  </style>
</head>
<body>
  <h1>ä¸­æ–‡èŠå¤©å®¤ Â· å•æˆ¿é—´</h1>
  <div class="row">
    <aside class="sidebar">
      <div style="font-weight:600;margin:6px 0">æˆ‘çš„èµ„æ–™</div>
      <div style="display:grid;gap:6px;margin-bottom:8px">
        <label>æ˜µç§° <input id="nickInput" type="text" placeholder="æ˜µç§°å…¨å±€å”¯ä¸€"/></label>
        <label>æ€§åˆ«
          <select id="genderInput">
            <option value="unset">unset</option>
            <option value="male">male</option>
            <option value="female">female</option>
          </select>
        </label>
        <button id="saveProfile" class="btn">ä¿å­˜èµ„æ–™</button>
        <div class="dim" id="saveHint"></div>
      </div>

      <div style="height:1px;background:var(--box);margin:10px 0"></div>

      <div style="font-weight:600;margin:6px 0">åœ¨çº¿ç”¨æˆ·ï¼ˆç‚¹å‡»å¯ç§èŠï¼‰</div>
      <div id="users"></div>
      <div class="dim" id="usersTip" style="margin-top:6px"></div>
    </aside>

    <main class="main">
      <div id="channelHint" class="hint">é¢‘é“ï¼š#generalï¼ˆå…¬èŠï¼‰</div>
      <div id="msgs" class="msgs"></div>

      <div class="toolbar">
        <label class="dim"><input id="dmchk" type="checkbox" disabled /> ç§èŠæ‰“å‹¾</label>
        <span id="who" class="dim"></span>
      </div>

      <div class="toolbar">
        <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼›Shift+Enter æ¢è¡Œ"></textarea>
        <button id="send" class="btn">å‘é€</button>
      </div>
      <div class="dim">è§„åˆ™ï¼šæœªé€‰æ‹©å¯¹è±¡ â†’ æ°¸è¿œå…¬èŠï¼›é€‰æ‹©å¯¹è±¡ä¸”å‹¾é€‰ â†’ ä»…åŒæ–¹å¯è§ï¼›é€‰æ‹©å¯¹è±¡æœªå‹¾é€‰ â†’ å…¬å±å¹¶ @Taã€‚</div>
    </main>
  </div>

  <!-- Firebase SDK v9ï¼ˆæ¨¡å— CDNï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection,
      query, orderBy, limit, onSnapshot, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // è¯»å– /firebaseConfig.json
    const cfg = await fetch('./firebaseConfig.json').then(r=>r.json());
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // å…ƒç´ 
    const els = {
      users: document.getElementById('users'),
      usersTip: document.getElementById('usersTip'),
      msgs: document.getElementById('msgs'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      dmchk: document.getElementById('dmchk'),
      channelHint: document.getElementById('channelHint'),
      who: document.getElementById('who'),
      nickInput: document.getElementById('nickInput'),
      genderInput: document.getElementById('genderInput'),
      saveProfile: document.getElementById('saveProfile'),
      saveHint: document.getElementById('saveHint'),
    };

    // çŠ¶æ€
    let me = null;                 // { uid, nickname, gender }
    let unsubMsgs = null;
    let dmTarget = null;

    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const clsByGender = g => g==='male'?'male':g==='female'?'female':'unset';
    const threadIdOf = (a,b)=> (a<b)?`${a}_${b}`:`${b}_${a}`;
    const rand = (n)=> Math.floor(Math.random()*n);
    const randNick = ()=> `guest_${rand(10)}${rand(10)}${rand(10)}${rand(10)}`;
    const randGender = ()=> ['male','female','unset'][rand(3)];

    // æŒ‰é’®ä¸è¾“å…¥äº‹ä»¶
    els.dmchk.addEventListener('change', ()=> renderHint());
    els.send.addEventListener('click', sendMessage);
    els.input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    els.saveProfile.addEventListener('click', saveProfile);

    // å¯åŠ¨ï¼šåŒ¿åç™»å½• â†’ è‡ªåŠ¨ç”Ÿæˆæ˜µç§°/æ€§åˆ«ï¼ˆæ— å¼¹çª—ï¼‰ï¼Œç”¨æˆ·å¯åœ¨ä¾§è¾¹æ ä¿®æ”¹
    await signInAnonymously(auth);
    onAuthStateChanged(auth, async (u)=>{
      if(!u) return;
      const uref = doc(db, 'users', u.uid);
      const us = await getDoc(uref);
      if(!us.exists()){
        // è‡ªåŠ¨ç”Ÿæˆå¯ç”¨æ˜µç§°ï¼ˆå ç”¨è¡¨å†²çªåˆ™é‡è¯•å‡ æ¬¡ï¼‰
        let nickname = randNick(), attempts = 0;
        while(attempts < 8){
          const nref = doc(db,'nicknames', nickname);
          if(!(await getDoc(nref)).exists()){ await setDoc(nref, { uid: u.uid }); break; }
          nickname = randNick(); attempts++;
        }
        const gender = randGender();
        await setDoc(uref, {
          uid: u.uid, nickname, gender,
          createdAt: serverTimestamp(), lastSeenAt: serverTimestamp(),
          roles: ['user'], blocked:false, mutedUntil:null
        });
        me = { uid:u.uid, nickname, gender };
      }else{
        me = us.data();
      }

      // è¡¨å•èµ‹å€¼
      els.nickInput.value = me.nickname || '';
      els.genderInput.value = me.gender || 'unset';

      subscribeUsers();
      renderHint();
      mountMessages();   // é»˜è®¤è®¢é˜…å…¬èŠ
    });

    // ä¿å­˜èµ„æ–™ï¼ˆæ”¹æ˜µç§°éœ€å…¨å±€å”¯ä¸€ï¼‰
    async function saveProfile(){
      if(!me) return;
      const newNick = (els.nickInput.value || '').trim();
      const newGender = els.genderInput.value || 'unset';
      if(!newNick){ els.saveHint.textContent='æ˜µç§°ä¸èƒ½ä¸ºç©º'; return; }

      try{
        if(newNick !== me.nickname){
          const nNewRef = doc(db,'nicknames', newNick);
          if((await getDoc(nNewRef)).exists()){ els.saveHint.textContent='æ˜µç§°å·²è¢«å ç”¨'; return; }
          // å…ˆå ç”¨æ–°æ˜µç§° â†’ å†é‡Šæ”¾æ—§æ˜µç§°ï¼ˆé¿å…ç©ºçª—æœŸï¼‰
          await setDoc(nNewRef, { uid: me.uid });
          if(me.nickname){
            const nOldRef = doc(db,'nicknames', me.nickname);
            const snap = await getDoc(nOldRef);
            if(snap.exists() && snap.data().uid === me.uid){ try{ await deleteDoc(nOldRef); }catch(e){} }
          }
        }
        await updateDoc(doc(db,'users', me.uid), {
          nickname: newNick, gender: newGender, lastSeenAt: serverTimestamp()
        });
        me.nickname = newNick; me.gender = newGender;
        els.saveHint.textContent = 'å·²ä¿å­˜';
        setTimeout(()=>els.saveHint.textContent='', 1500);
        renderHint(); // åˆ·æ–°æ ‡é¢˜æ˜¾ç¤º
      }catch(err){
        els.saveHint.textContent = 'ä¿å­˜å¤±è´¥ï¼ˆè§„åˆ™æˆ–ç½‘ç»œé—®é¢˜ï¼‰';
      }
    }

    // æ¸²æŸ“æç¤º & æ§ä»¶çŠ¶æ€
    function renderHint(){
      if(dmTarget){
        els.channelHint.textContent = `ç›®æ ‡ï¼š@${dmTarget.nickname}`;
        els.who.textContent = 'å‹¾é€‰ç§èŠ = ä»…åŒæ–¹å¯è§ï¼›ä¸å‹¾é€‰ = å…¬å±å¹¶ @Ta';
        els.dmchk.disabled = false;
      }else{
        els.channelHint.textContent = 'é¢‘é“ï¼š#generalï¼ˆå…¬èŠï¼‰';
        els.who.textContent = '';
        els.dmchk.checked = false;
        els.dmchk.disabled = true; // æ²¡é€‰å¯¹è±¡å°±ç¦ç”¨â€œç§èŠæ‰“å‹¾â€
      }
    }

    // åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    function subscribeUsers(){
      const q = query(collection(db,'users'), orderBy('createdAt','asc'), limit(500));
      onSnapshot(q, snap=>{
        const arr = []; snap.forEach(d=>arr.push(d.data()));
        els.users.innerHTML = arr.map(u =>
          `<span class="pill ${clsByGender(u.gender)}" data-uid="${u.uid}" data-nick="${u.nickname}">@${u.nickname}</span>`
        ).join('');
        els.usersTip.textContent = arr.length ? '' : 'å½“å‰åªæœ‰ä½ åœ¨çº¿ï¼Œæ‰“å¼€å¦ä¸€ä¸ªæµè§ˆå™¨/è®¾å¤‡å¯ä¸€èµ·æµ‹è¯•';
        [...els.users.querySelectorAll('.pill')].forEach(p=>{
          p.addEventListener('click', ()=>{
            const uid = p.dataset.uid;
            if(uid === me.uid) return; // ä¸å’Œè‡ªå·±ç§èŠ
            dmTarget = { uid, nickname:p.dataset.nick };
            renderHint();
            // ä¸åˆ‡æ¢è®¢é˜…ï¼Œé™¤éå‹¾é€‰â€œç§èŠâ€
            if(els.dmchk.checked) mountMessages();
          });
        });
      });
    }

    // è®¢é˜…æ¶ˆæ¯ï¼ˆæ ¹æ®æ˜¯å¦å¤„äºâ€œå‹¾é€‰ç§èŠçŠ¶æ€â€ï¼‰
    async function mountMessages(){
      if(unsubMsgs) { unsubMsgs(); unsubMsgs=null; }
      els.msgs.innerHTML = '';

      const dmChecked = els.dmchk.checked;
      if(dmTarget && dmChecked){
        // ç§èŠ
        const tid = threadIdOf(me.uid, dmTarget.uid);
        await setDoc(doc(db,'dmThreads', tid), { participants: [me.uid, dmTarget.uid] }, { merge:true });
        const q = query(collection(db,'dmThreads', tid, 'messages'), orderBy('createdAt','asc'), limit(500));
        unsubMsgs = onSnapshot(q, snap=>{
          els.msgs.innerHTML = '';
          snap.forEach(d=>renderMsg(d.id, d.data(), {scope:'dm', tid}));
          els.msgs.scrollTop = els.msgs.scrollHeight;
        });
      }else{
        // å…¬èŠï¼ˆé»˜è®¤ï¼‰
        const q = query(collection(db,'messages'), orderBy('createdAt','asc'), limit(500));
        unsubMsgs = onSnapshot(q, snap=>{
          els.msgs.innerHTML = '';
          snap.forEach(d=>renderMsg(d.id, d.data(), {scope:'general'}));
          els.msgs.scrollTop = els.msgs.scrollHeight;
        });
      }
    }

    function renderMsg(id, m, ctx){
      const line = document.createElement('div');
      line.className = 'msg';
      const gcls = clsByGender(m.from?.gender||'unset');
      const lock = m.isPrivate ? 'ğŸ”’ ' : '';
      const text = m.recalled ? '<span class="dim">ï¼ˆè¯¥æ¶ˆæ¯å·²æ’¤å›ï¼‰</span>'
                : m.deleted ? '<span class="dim">ï¼ˆè¯¥æ¶ˆæ¯å·²åˆ é™¤ï¼Œä»…ä½œè€…å¯è§ï¼‰</span>'
                : (m.text || '').replace(/@(\w+)/g, '<strong>@$1</strong>');
      line.innerHTML = `${lock}<span class="nick ${gcls}" data-uid="${m.from.uid}" data-nick="${m.from.nickname}">@${m.from.nickname}</span>: ${text}`;

      // ç‚¹æ˜µç§° -> é€‰ä¸ºç§èŠå¯¹è±¡
      line.querySelector('.nick')?.addEventListener('click', (e)=>{
        const uid = e.target.dataset.uid;
        if(uid === me.uid) return;
        dmTarget = { uid, nickname:e.target.dataset.nick };
        renderHint();
      });

      // è‡ªå·±çš„æ¶ˆæ¯ + 120s å†… -> æ˜¾ç¤ºæ’¤å›/åˆ é™¤æŒ‰é’®
      const mine = me && m.from?.uid === me.uid;
      const ts = m.createdAt && m.createdAt.toMillis ? m.createdAt.toMillis() : 0;
      const within120 = ts && (Date.now() - ts) < 120000;

      if(mine && within120 && !m.recalled && !m.deleted){
        const btns = document.createElement('div');
        btns.style.marginTop = '4px';
        const b1 = document.createElement('button'); b1.className='btn'; b1.textContent='æ’¤å›';
        const b2 = document.createElement('button'); b2.className='btn'; b2.style.color='#ef4444'; b2.style.borderColor='#ef4444'; b2.textContent='åˆ é™¤';
        btns.appendChild(b1); btns.appendChild(b2);
        b1.onclick = async ()=>{
          try {
            if(ctx.scope==='dm'){
              await updateDoc(doc(db,'dmThreads', ctx.tid, 'messages', id), { recalled:true });
            }else{
              await updateDoc(doc(db,'messages', id), { recalled:true });
            }
          } catch(e){ alert('æ’¤å›å¤±è´¥ï¼šè¶…æ—¶æˆ–è§„åˆ™é™åˆ¶'); }
        };
        b2.onclick = async ()=>{
          try {
            if(ctx.scope==='dm'){
              await updateDoc(doc(db,'dmThreads', ctx.tid, 'messages', id), { deleted:true });
            }else{
              await updateDoc(doc(db,'messages', id), { deleted:true });
            }
          } catch(e){ alert('åˆ é™¤å¤±è´¥ï¼šè¶…æ—¶æˆ–è§„åˆ™é™åˆ¶'); }
        };
        line.appendChild(btns);
      }

      els.msgs.appendChild(line);
    }

    // å‘é€æ¶ˆæ¯ï¼šæœªé€‰æ‹©å¯¹è±¡ â†’ ä¸€å¾‹å…¬èŠï¼ˆä¸ä¼šå¡ä½ï¼‰
    async function sendMessage(){
      if(!me) return;
      const raw = els.input.value.trim();
      if(!raw) return;

      const dmChecked = els.dmchk.checked;

      try{
        if(dmTarget && dmChecked){
          // ç§èŠ
          const tid = threadIdOf(me.uid, dmTarget.uid);
          await setDoc(doc(db,'dmThreads', tid), { participants:[me.uid, dmTarget.uid] }, { merge:true });
          await addDoc(collection(db,'dmThreads', tid, 'messages'), {
            from:{ uid:me.uid, nickname:me.nickname, gender:me.gender },
            to: dmTarget.uid, isPrivate:true,
            text: raw, emoji:[], mentions:[],
            createdAt: serverTimestamp(), recalled:false, deleted:false
          });
        }else{
          // å…¬èŠï¼ˆé»˜è®¤ï¼‰ï¼›è‹¥é€‰äº†å¯¹è±¡ä½†æœªå‹¾é€‰ï¼Œåˆ™ @Ta
          const tx = (dmTarget && !dmChecked) ? `@${dmTarget.nickname} ${raw}` : raw;
          await addDoc(collection(db,'messages'), {
            from:{ uid:me.uid, nickname:me.nickname, gender:me.gender },
            to:null, isPrivate:false,
            text: tx, emoji:[], mentions:[],
            createdAt: serverTimestamp(), recalled:false, deleted:false
          });
        }
        els.input.value='';
        await sleep(10);
        els.msgs.scrollTop = els.msgs.scrollHeight;
      }catch(e){
        console.error(e);
        alert('å‘é€å¤±è´¥ï¼šè¯·æ£€æŸ¥ Firestore è§„åˆ™æ˜¯å¦å·² Publishã€Auth æ˜¯å¦å¯ç”¨ Anonymous');
      }
    }
  </script>
</body>
</html>
