<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆæ‰“å‹¾ï¼‰</title>
  <style>
    :root{
      --fg:#111;--muted:#666;--box:#e5e7eb;--bg:#fff;--chip:#f3f4f6;--accent:#111;
      --male:#1d4ed8;--female:#d946ef;--unset:#6b7280;--danger:#b91c1c;--ok:#065f46
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);margin:14px;background:var(--bg)}
    h1{font-size:18px;margin:0 0 10px}
    .app{display:flex;gap:12px}
    .left{width:260px;border:1px solid var(--box);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;max-height:86vh}
    .right{flex:1;border:1px solid var(--box);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;max-height:86vh}
    .me{font-size:13px;color:var(--muted);margin-bottom:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .edit{border:1px solid var(--box);background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}
    .list{flex:1;overflow:auto;border:1px solid var(--box);border-radius:10px;padding:8px;background:#fafafa}
    .grp{font-size:12px;color:var(--muted);margin:6px 0 4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;margin:4px 6px 4px 0;border:1px solid var(--box);border-radius:999px;background:#fff;cursor:pointer}
    .male{color:var(--male)} .female{color:var(--female)} .unset{color:var(--unset)}
    .badge{font-size:10px;border:1px solid var(--box);border-radius:999px;padding:0 6px;color:var(--muted);background:#fff}
    .msgs{flex:1;overflow:auto;border:1px solid var(--box);border-radius:10px;padding:8px;background:#fafafa}
    .msg{margin:8px 0;line-height:1.45}
    .nick{font-weight:600;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    textarea{flex:1;min-height:54px;resize:vertical;border:1px solid var(--box);border-radius:10px;padding:8px}
    button{border:1px solid var(--box);background:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .banner{display:none;margin:0 0 8px;padding:8px;border-radius:10px}
    .banner.err{display:block;background:#fee2e2;border:1px solid #fecaca;color:var(--danger)}
    .banner.ok{display:block;background:#dcfce7;border:1px solid #bbf7d0;color:var(--ok)}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--box);border-radius:999px;padding:4px 10px;background:var(--chip);cursor:pointer;margin-right:6px}
    .sel{outline:2px solid #1112}
  </style>
</head>
<body>
  <h1>ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆæ‰“å‹¾ï¼‰</h1>
  <div id="net" class="banner"></div>
  <div class="app">
    <aside class="left">
      <div id="me" class="me">åˆå§‹åŒ–ä¸­â€¦</div>
      <div class="grp">åœ¨çº¿ç”¨æˆ·</div>
      <div id="users" class="list"></div>
      <div class="grp">ç¤ºä¾‹è´¦å·ï¼ˆæœ¬åœ°ï¼Œä¸å åç«¯ï¼‰</div>
      <div id="samples" class="list" style="min-height:72px"></div>
    </aside>

    <main class="right">
      <div id="mode" class="hint">é¢‘é“ï¼š#generalï¼ˆæœªé€‰äºº â†’ å…¬èŠï¼‰</div>
      <div id="msgs" class="msgs"></div>

      <div class="row">
        <label class="hint" style="display:flex;align-items:center;gap:6px">
          <input id="dmchk" type="checkbox" checked />
          ç§èŠæ‰“å‹¾ï¼ˆå‹¾é€‰=ä»…åŒæ–¹å¯è§ï¼›ä¸å‹¾é€‰=å…¬å±å¹¶è‡ªåŠ¨ @ï¼‰
        </label>
      </div>

      <div class="row">
        <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦  Enter å‘é€ï¼›Shift+Enter æ¢è¡Œ"></textarea>
        <button id="send">å‘é€</button>
      </div>

      <div class="hint">
        å¿«æ· @ï¼š <span class="chip" data-at="@ç³»ç»Ÿé€šçŸ¥">@ç³»ç»Ÿé€šçŸ¥</span>
        <span class="chip" data-at="@ç®¡ç†å‘˜A">@ç®¡ç†å‘˜A</span>
        <span class="chip" data-at="@è®¿å®¢B">@è®¿å®¢B</span>
      </div>
    </main>
  </div>

  <!-- Firebase v9 æ¨¡å— CDNï¼ˆæ³¨æ„ï¼šä¸è¦å¸¦ä»»ä½•çœç•¥å·ï¼‰ -->
  <script type="module">
    // â€”â€” æ­£ç¡®åŠ è½½é…ç½® â€”â€” //
    async function loadConfig(){
      const res = await fetch('./firebaseConfig.json', {cache:'no-store'});
      if(!res.ok) throw new Error('æ— æ³•è¯»å– firebaseConfig.json');
      return await res.json();
    }

    const cfg = await loadConfig();

    // â€”â€” Firebase SDK â€”â€” //
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection,
      query, orderBy, onSnapshot, updateDoc, where, getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app  = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // â€”â€” DOM refs â€”â€” //
    const el = {
      net: document.getElementById('net'),
      me: document.getElementById('me'),
      users: document.getElementById('users'),
      samples: document.getElementById('samples'),
      msgs: document.getElementById('msgs'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      dmchk: document.getElementById('dmchk'),
      mode: document.getElementById('mode'),
      chips: [...document.querySelectorAll('[data-at]')],
    };

    // â€”â€” æœ¬åœ°çŠ¶æ€ â€”â€” //
    let me = null;               // {uid, nickname, gender, roles[]}
    let dmTarget = null;         // { uid, nickname, gender }
    let dmChecked = true;

    // â€”â€” å·¥å…· â€”â€” //
    const males = ['é˜¿å¼º','å»ºå›½','ä¸€é¸£','å­è½©','å¿—è¿œ','æµ©ç„¶'];
    const females = ['ç¾ç³','å¯æ¬£','è¯­æ¡','å˜‰æ€¡','è‹¥å…°','æ¬£æ€¡'];
    const rnd = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const randGender = ()=> (Math.random() < 0.5 ? 'male':'female');
    const randNick = ()=> (randGender()==='male' ? rnd(males) : rnd(females)) + Math.floor(Math.random()*90+10);

    const clsByGender = (g)=> g==='male'?'male':(g==='female'?'female':'unset');

    function banner(type, text){
      el.net.className = 'banner ' + (type==='err'?'err':'ok');
      el.net.textContent = text;
      if(type!=='err'){ setTimeout(()=>{el.net.className='banner';}, 1600); }
    }

    function setModeHint(){
      if(!dmTarget){ el.mode.textContent = 'é¢‘é“ï¼š#generalï¼ˆæœªé€‰äºº â†’ å…¬èŠï¼‰'; return; }
      el.mode.textContent = dmChecked ? `ğŸ”’ ç§èŠå¯¹è±¡ï¼š@${dmTarget.nickname}` : `ğŸ—£ï¸ å…¬å±å‘è¨€å¹¶ @${dmTarget.nickname}`;
    }

    function scrollToBottom(){ el.msgs.scrollTop = el.msgs.scrollHeight; }

    function pill(u, selectable=true){
      const cls = clsByGender(u.gender||'unset');
      const admin = (u.roles||[]).includes('admin') ? '<span class="badge">admin</span>' : '';
      const cur = me && u.uid===me.uid ? ' sel' : '';
      return `<span class="pill ${cls}${cur}" data-uid="${u.uid||''}" data-nick="${u.nickname||''}" data-selectable="${selectable?1:0}">
                <strong>@${u.nickname||'æœªçŸ¥'}</strong> ${admin}
              </span>`;
    }

    function bindPills(container){
      [...container.querySelectorAll('.pill')].forEach(p=>{
        p.addEventListener('click', ()=>{
          const selectable = p.dataset.selectable === '1';
          const uid = p.dataset.uid, nick = p.dataset.nick;
          if(!selectable){
            // ç¤ºä¾‹è´¦å· â†’ åœ¨è¾“å…¥æ¡†æ’å…¥ @æ˜µç§°
            const at = '@'+nick+' ';
            if(!el.input.value.startsWith(at)) el.input.value = at + el.input.value;
            el.input.focus();
            dmTarget = null; setModeHint(); // ä¸è¿›å…¥ç§èŠ
            return;
          }
          if(uid){
            dmTarget = { uid, nickname:nick, gender:'unset' };
            setModeHint();
          }
        });
      });
    }

    function renderUsers(list){
      el.users.innerHTML = list.map(u=>pill(u,true)).join('');
      bindPills(el.users);
    }

    function renderSamples(){
      const samples = [
        {nickname:'ç³»ç»Ÿé€šçŸ¥', gender:'unset'},
        {nickname:'ç®¡ç†å‘˜A', gender:'male'},
        {nickname:'è®¿å®¢B', gender:'female'}
      ];
      el.samples.innerHTML = samples.map(s=>pill({nickname:s.nickname,gender:s.gender}, false)).join('');
      bindPills(el.samples);
    }

    function renderMsg(m){
      const gcls = clsByGender(m.from?.gender||'unset');
      const nick = `<span class="nick ${gcls}" data-uid="${m.from?.uid||''}" data-nick="${m.from?.nickname||''}">@${m.from?.nickname||'æœªçŸ¥'}</span>`;
      const scope = m.isPrivate ? 'ğŸ”’ ' : '';
      const body = m.recalled ? '<span class="hint">ï¼ˆå·²æ’¤å›ï¼‰</span>' :
                (m.deleted ? '<span class="hint">ï¼ˆå·²åˆ é™¤ï¼Œä»…ä½œè€…å¯è§ï¼‰</span>' :
                  (m.text||'').replace(/@([\u4e00-\u9fa5\w]+)/g, '<strong>@$1</strong>'));
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `${scope}${nick}ï¼š${body}`;
      div.querySelector('.nick')?.addEventListener('click', (e)=>{
        const uid = e.target.dataset.uid, nick = e.target.dataset.nick;
        if(uid){ dmTarget = { uid, nickname:nick, gender:'unset' }; setModeHint(); }
      });
      el.msgs.appendChild(div);
      scrollToBottom();
    }

    async function ensureUniqueNickname(desired){
      // nicknames/{name} æ–‡æ¡£å ç”¨è¡¨
      const ref = doc(db,'nicknames', desired);
      const snap = await getDoc(ref);
      if(snap.exists()) return false;
      await setDoc(ref, { uid: me.uid });
      return true;
    }

    async function changeProfile(){
      const nn = prompt('ä¿®æ”¹æ˜µç§°ï¼ˆéœ€å”¯ä¸€ï¼‰ï¼š', me.nickname || '');
      if(!nn) return;
      if(nn!==me.nickname){
        const ok = await ensureUniqueNickname(nn).catch(()=>false);
        if(!ok){ banner('err','æ˜µç§°å·²è¢«å ç”¨'); return; }
      }
      let g = prompt('æ€§åˆ«ï¼šmale / female / unset', me.gender || 'unset');
      g = (g||'unset').toLowerCase();
      await setDoc(doc(db,'users', me.uid), {
        ...me, nickname: nn, gender: g, lastSeenAt: serverTimestamp()
      }, {merge:true});
      me.nickname = nn; me.gender = g;
      renderMe();
    }

    function renderMe(){
      const cls = clsByGender(me.gender||'unset');
      const admin = (me.roles||[]).includes('admin') ? '<span class="badge">admin</span>' : '';
      el.me.innerHTML = `
        <span>æˆ‘ï¼š<strong class="${cls}">@${me.nickname}</strong>ï¼ˆ${me.gender}ï¼‰${admin}</span>
        <button class="edit" id="btnEdit">ç¼–è¾‘æ˜µç§°/æ€§åˆ«</button>
        <button class="edit" id="btnClearDM">æ¸…é™¤ç§èŠå¯¹è±¡</button>
      `;
      document.getElementById('btnEdit').onclick = changeProfile;
      document.getElementById('btnClearDM').onclick = ()=>{ dmTarget=null; setModeHint(); };
    }

    function subscribeUsers(){
      const q = query(collection(db,'users'), orderBy('createdAt','asc'));
      onSnapshot(q, snap=>{
        const arr = []; snap.forEach(d=>arr.push(d.data()));
        renderUsers(arr);
      }, err=>{
        banner('err', 'ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥ï¼š'+err.message);
      });
    }

    function subscribePublic(){
      const q = query(collection(db,'messages'), orderBy('createdAt','asc'));
      onSnapshot(q, snap=>{
        el.msgs.innerHTML = '';
        snap.forEach(d=>renderMsg(d.data()));
      }, err=>{
        banner('err','æ¶ˆæ¯è®¢é˜…å¤±è´¥ï¼š'+err.message);
      });
    }

    async function send(){
      if(!me) return;
      const txt = el.input.value.trim();
      if(!txt) return;

      try{
        if(dmTarget && dmChecked){
          // ç§èŠ
          const a = me.uid < dmTarget.uid ? me.uid : dmTarget.uid;
          const b = me.uid < dmTarget.uid ? dmTarget.uid : me.uid;
          const tid = `${a}_${b}`;
          await setDoc(doc(db,'dmThreads', tid), { participants:[a,b] }, {merge:true});
          await addDoc(collection(db,'dmThreads', tid, 'messages'), {
            from:{ uid:me.uid, nickname:me.nickname, gender:me.gender },
            to:dmTarget.uid, isPrivate:true,
            text: txt, emoji:[], mentions:[],
            createdAt: serverTimestamp(), recalled:false, deleted:false
          });
          banner('ok','å·²å‘é€ç§èŠæ¶ˆæ¯');
        }else{
          // å…¬èŠï¼ˆè‹¥é€‰äº†å¯¹è±¡ä½†ä¸æ‰“å‹¾ â†’ è‡ªåŠ¨ @ å¯¹æ–¹ï¼‰
          const t = (dmTarget && !dmChecked) ? `@${dmTarget.nickname} ${txt}` : txt;
          await addDoc(collection(db,'messages'), {
            from:{ uid:me.uid, nickname:me.nickname, gender:me.gender },
            to:null, isPrivate:false,
            text: t, emoji:[], mentions:[],
            createdAt: serverTimestamp(), recalled:false, deleted:false
          });
        }
        el.input.value = '';
      }catch(e){
        banner('err','å‘é€å¤±è´¥ï¼š'+e.message);
      }
    }

    // â€”â€” äº‹ä»¶ â€”â€” //
    el.dmchk.addEventListener('change', e=>{ dmChecked = e.target.checked; setModeHint(); });
    el.send.addEventListener('click', send);
    el.input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
    el.chips.forEach(c=>c.addEventListener('click', ()=>{
      const at = c.dataset.at + ' ';
      if(!el.input.value.startsWith(at)) el.input.value = at + el.input.value;
      el.input.focus();
    }));

    // â€”â€” å¯åŠ¨ï¼šåŒ¿åç™»å½• + åˆ›å»º/è¯»å–ä¸ªäººæ¡£æ¡ˆ â€”â€” //
    signInAnonymously(auth).catch(e=>{
      banner('err','åŒ¿åç™»å½•å¤±è´¥ï¼š'+e.message);
    });

    onAuthStateChanged(auth, async (u)=>{
      if(!u) return;
      try{
        const uref = doc(db,'users', u.uid);
        const snap = await getDoc(uref);
        if(!snap.exists()){
          // é¦–æ¬¡ï¼šéšæœºæ˜µç§° + æ€§åˆ«ï¼›å¹¶ç«‹å³å†™å…¥
          const gender = randGender();
          const nickname = randNick();
          // å ç”¨æ˜µç§°ï¼ˆè‹¥å†²çªåˆ™ç®€å•åŠ å°¾å·ï¼‰
          let ok = await ensureUniqueNickname(nickname).catch(()=>false);
          let finalNick = nickname, tryN = 0;
          while(!ok && tryN<3){
            finalNick = nickname + (Math.floor(Math.random()*90+10));
            ok = await ensureUniqueNickname(finalNick).catch(()=>false);
            tryN++;
          }
          await setDoc(uref, {
            uid:u.uid, nickname: finalNick, gender,
            createdAt: serverTimestamp(), lastSeenAt: serverTimestamp(),
            roles: ['user'], blocked:false, mutedUntil:null
          });
          me = { uid:u.uid, nickname: finalNick, gender, roles:['user'] };
        }else{
          me = snap.data();
        }
        renderMe(); renderSamples(); subscribeUsers(); subscribePublic();
        setModeHint(); banner('ok','å·²ç™»å½•å¹¶è¿æ¥åç«¯');
      }catch(e){
        banner('err','åˆå§‹åŒ–å¤±è´¥ï¼š'+e.message);
      }
    });

    // â€”â€” ç®€å•ç½‘ç»œæ¢æµ‹ï¼ˆé‡åˆ° Firebase ç¦»çº¿æŠ¥é”™æ—¶ç»™å‡ºæ¨ªå¹…ï¼Œå¹¶è‡ªåŠ¨æ¶ˆéšï¼‰ â€”â€” //
    window.addEventListener('online', ()=>banner('ok','ç½‘ç»œå·²æ¢å¤'));
    window.addEventListener('offline', ()=>banner('err','ç½‘ç»œä¸å¯ç”¨ï¼šè¯·æ£€æŸ¥è¿æ¥'));
  </script>
</body>
</html>
