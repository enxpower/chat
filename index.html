<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆåŒå±é«˜äº®ï¼‰</title>
<style>
  :root{--fg:#0f172a;--muted:#6b7280;--line:#e5e7eb;--bg:#f8fafc;--card:#fff;--male:#2563eb;--female:#d946ef;--unset:#64748b;--admin:#f97316;--shadow:0 8px 24px rgba(2,6,23,.06)}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);background:#f8fafc}
  header{padding:14px 18px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:9}
  .brand{font-size:16px;font-weight:700}

  .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}

  .left{padding:14px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 110px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .me{display:flex;flex-direction:column;gap:10px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fbfbfb}
  .tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:#6b7280;background:#fff}

  .male{color:#2563eb}.female{color:#d946ef}.unset{color:#64748b}.adminname{color:var(--admin)!important}
  .ipt{width:100%;border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn.primary{border-color:#111;color:#111;background:#fff}.btn:active{transform:translateY(1px)}

  .list{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin:4px 6px 4px 0;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .badge{font-size:10px;border:1px solid var(--line);border-radius:999px;padding:0 6px;color:#6b7280;background:#fff}
  .grp{font-size:12px;color:#6b7280;margin:2px 0 6px 2px}

  .right{display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;padding:14px;height:calc(100vh - 110px)}
  .mode{color:#6b7280;font-size:12px}
  .msgs{overflow:auto;border:1px solid var(--line);border-radius:12px;background:#ffffff}
  .sendto{color:#374151;font-size:12px;padding:2px 6px}
  .sendto strong{color:#111}

  .bubble{margin:10px 12px;max-width:78%}
  .from{font-size:12px;margin-bottom:4px}
  .b{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#f5f7fb}
  .mebubble .b{background:#eef2ff;border-color:#c7d2fe}
  .priv .b{background:#f6f0ff;border-color:#e9d5ff}
  .priv .from::before{content:"ğŸ”’ ";}

  textarea{flex:1;min-height:56px;resize:vertical;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

  .status{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;margin:10px auto 0;max-width:1200px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);box-shadow:var(--shadow);background:#ffffffcc;backdrop-filter:saturate(180%) blur(8px)}
  .status .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;animation:bl 1.2s infinite}.status.ok .dot{background:#10b981}.status.err .dot{background:#ef4444}
  @keyframes bl{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
</style>
</head>
<body>
<header><div class="brand">ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆåŒå±é«˜äº®ï¼‰</div></header>
<div id="status" class="status"><span class="dot"></span><span id="statusText">æ­£åœ¨è¿æ¥ Firebaseâ€¦</span></div>

<div class="wrap">
  <!-- å·¦ä¾§ -->
  <aside class="card left">
    <div class="me">
      <div class="row">
        <span>æˆ‘ï¼š<strong id="meNick" class="unset">@guest</strong></span>
        <span id="meRole" class="tag">user</span>
      </div>

      <!-- ç®¡ç†å‘˜ç™»å½•ï¼ˆç™»å½•åéšè—ï¼›åªç•™é€€å‡ºï¼‰ -->
      <div class="row" id="adminLoginRow">
        <input id="adminEmail" class="ipt" placeholder="ç®¡ç†å‘˜é‚®ç®±" style="min-width:160px">
        <input id="adminPass" class="ipt" type="password" placeholder="å¯†ç " style="min-width:120px">
        <button class="btn" id="adminLoginBtn">ç™»å½•</button>
      </div>
      <div class="row" id="adminLogoutRow" style="display:none">
        <button class="btn" id="adminLogoutBtn">é€€å‡ºç®¡ç†å‘˜</button>
      </div>

      <!-- ç®¡ç†å‘˜æ¨¡å¼å¼€å…³ï¼ˆä»…ç®¡ç†å‘˜æ˜¾ç¤ºï¼‰ -->
      <div id="adminBar" class="row" style="display:none">
        <label style="font-size:12px;color:#374151;display:flex;align-items:center;gap:6px">
          <input id="adminAll" type="checkbox"/>
          ç®¡ç†å‘˜æ¨¡å¼ï¼šæŸ¥çœ‹å…¨éƒ¨ç§èŠï¼ˆé»˜è®¤å…³é—­ï¼‰
        </label>
      </div>

      <!-- æ¡£æ¡ˆè®¾ç½® -->
      <div class="row">
        <input id="nickInput" class="ipt" placeholder="æ˜µç§°ï¼ˆå”¯ä¸€ï¼Œå¯é€‰ï¼‰"/>
        <select id="genderInput" class="ipt" style="max-width:120px">
          <option value="unset">æœªè®¾ç½®</option>
          <option value="male">male</option>
          <option value="female">female</option>
        </select>
        <button class="btn" id="saveProfile">ä¿å­˜</button>
      </div>
    </div>

    <div class="grp">åœ¨çº¿ç”¨æˆ·</div>
    <div id="users" class="list"></div>
  </aside>

  <!-- å³ä¾§ï¼šå•ä¸€æ¶ˆæ¯æµ -->
  <main class="card right">
    <div id="mode" class="mode">é¢‘é“ï¼š#generalï¼ˆç§èŠåŒå±é«˜äº®ï¼Œä»…åŒæ–¹å¯è§ï¼‰</div>
    <div id="msgs" class="msgs"></div>

    <!-- å°†å‘é€åˆ°ï¼š æ”¾åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ -->
    <div id="sendto" class="sendto">å°†å‘é€åˆ°ï¼š<strong>å…¬å±</strong></div>

    <div class="row" style="color:#6b7280;font-size:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="dmchk" type="checkbox" checked /> ç§èŠæ‰“å‹¾ï¼ˆå‹¾é€‰=ä»…åŒæ–¹å¯è§ï¼›ä¸å‹¾é€‰=å‘åˆ°å…¬å±å¹¶è‡ªåŠ¨ @ï¼‰
      </label>
    </div>

    <div class="row">
      <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦  Enter å‘é€ï¼›Shift+Enter æ¢è¡Œ"></textarea>
      <button id="send" class="btn primary">å‘é€</button>
    </div>

    <!-- ä»…ä¿ç•™ @ç®¡ç†å‘˜ å¿«æ·æŒ‰é’®ï¼ˆåå­—åŠ¨æ€ä½¿ç”¨ç™½åå•ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜åç§°æœ‰ä¸“å±é¢œè‰²ï¼‰ -->
    <div class="chips">
      <span class="chip" id="chipAdmin">@ç®¡ç†å‘˜</span>
    </div>
  </main>
</div>

<script type="module">
  // ===== å¸¸é©»çŠ¶æ€æ¡ =====
  const $ = id => document.getElementById(id);
  const statusText = $('statusText');
  const setStatus = (kind, text)=>{ const bar=document.getElementById('status'); bar.className='status '+(kind||''); statusText.textContent=text||''; bar.style.display='flex'; };

  // ===== åªä» firebaseConfig.json è¯»å–é…ç½® =====
  async function loadConfig(){
    const r = await fetch('./firebaseConfig.json', {cache:'no-store'});
    if(!r.ok) throw new Error(`è¯»å– firebaseConfig.json å¤±è´¥ï¼ˆHTTP ${r.status}ï¼‰`);
    const cfg = await r.json();
    const bad = v => !v || typeof v!=='string' || /YOUR_|<|>|\s/.test(v) || v.length<10;
    if (bad(cfg.apiKey) || bad(cfg.appId)) throw new Error('é…ç½®æ— æ•ˆï¼šapiKey/appId ä¼¼ä¹æ˜¯å ä½å€¼');
    return cfg;
  }
  const cfg = await loadConfig();

  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  const app = initializeApp(cfg); const auth = getAuth(app); const db = getFirestore(app);

  window.addEventListener('unhandledrejection', ev=> setStatus('err','è¿è¡Œé”™è¯¯ï¼š'+(ev.reason?.message||ev.reason||'Unknown')));

  // ===== é…ç½®ï¼šè™šæ‹Ÿåœ¨çº¿ç”¨æˆ·ï¼ˆå¥³æ€§ï¼‰ =====
  // åœ¨è¿™é‡Œå¢åˆ å³å¯ã€‚uid ä»¥ v_ å¼€å¤´ï¼Œé¿å…ä¸çœŸå®ç”¨æˆ·å†²çªã€‚
  const VIRTUAL_USERS = [
    { uid:'v_f01', nickname:'ç¾ç³33', gender:'female' },
    { uid:'v_f02', nickname:'è¯­æ¡27', gender:'female' },
    { uid:'v_f03', nickname:'å˜‰æ€¡45', gender:'female' },
    { uid:'v_f04', nickname:'è‹¥å…°29', gender:'female' },
    { uid:'v_f05', nickname:'æ¬£æ€¡38', gender:'female' }
  ];

  // ===== DOM refs =====
  const el = {
    users:$('users'), msgs:$('msgs'),
    input:$('input'), send:$('send'), dmchk:$('dmchk'), sendto:$('sendto'),
    meNick:$('meNick'), meRole:$('meRole'), nickInput:$('nickInput'), genderInput:$('genderInput'),
    saveProfile:$('saveProfile'),
    adminBar:$('adminBar'), adminAll:$('adminAll'),
    adminLoginRow:$('adminLoginRow'), adminLogoutRow:$('adminLogoutRow'),
    adminEmail:$('adminEmail'), adminPass:$('adminPass'), adminLoginBtn:$('adminLoginBtn'), adminLogoutBtn:$('adminLogoutBtn'),
    chipAdmin:$('chipAdmin')
  };

  // ===== çŠ¶æ€ =====
  let me={ uid:null, nickname:'guest', gender:'unset', roles:['user'] };
  let dmTarget=null;
  let amAdmin=false;
  let adminUIDs=[];                        // ç™½åå•ç®¡ç†å‘˜ UID åˆ—è¡¨
  let adminDisplay = { uid:null, nickname:'ç®¡ç†å‘˜' }; // ç”¨äº @ç®¡ç†å‘˜ å¿«æ·æŒ‰é’®
  let unsubDm=null;

  // é¢œè‰²ç±»ï¼šç®¡ç†å‘˜ > æ€§åˆ« > æœªè®¾
  const nameClass=(uid, gender)=>{
    if (adminUIDs.includes(uid)) return 'adminname';
    if ((uid||'').startsWith('v_')) return 'female'; // è™šæ‹Ÿå¥³æ€§ç»Ÿä¸€æŒ‰å¥³æ€§è‰²
    return gender==='male'?'male':(gender==='female'?'female':'unset');
  };

  const updateSendTo=()=>{
    if(dmTarget?.uid && el.dmchk.checked){
      el.sendto.innerHTML=`å°†å‘é€åˆ°ï¼š<strong class="${nameClass(dmTarget.uid,'unset')}">@${dmTarget.nickname}</strong>ï¼ˆç§èŠï¼‰`;
    }else if(dmTarget?.uid && !el.dmchk.checked){
      el.sendto.innerHTML=`å°†å‘é€åˆ°ï¼š<strong>å…¬å±</strong>ï¼ˆå·²é€‰æ‹© <span class="${nameClass(dmTarget.uid,'unset')}">@${dmTarget.nickname}</span>ï¼Œè‹¥è¦ç§èŠè¯·å‹¾é€‰ï¼‰`;
    }else{
      el.sendto.innerHTML='å°†å‘é€åˆ°ï¼š<strong>å…¬å±</strong>';
    }
  };

  // åœ¨çº¿ç”¨æˆ·
  function onPillClick(e){
    const p=e.currentTarget; const uid=p.dataset.uid; const nick=p.dataset.nick;
    if(!uid || uid===me.uid){ el.dmchk.checked=false; dmTarget=null; updateSendTo(); return; }
    dmTarget={uid,nickname:nick}; el.dmchk.checked=true; updateSendTo();
  }
  const pill=(u)=>{
    const s=document.createElement('span'); s.className='pill '+nameClass(u.uid,u.gender);
    s.dataset.uid=u.uid||''; s.dataset.nick=u.nickname||'';
    const isadm = adminUIDs.includes(u.uid);
    const isvir = false; // æˆ–è€…ä¿ç•™åŸåˆ¤æ–­ä½†åœ¨ä¸‹ä¸€è¡Œæ¨¡æ¿é‡Œä¸ç”¨å®ƒ;
    s.innerHTML=`<strong>@${u.nickname||'æœªçŸ¥'}</strong> ${isadm?'<span class="badge">admin</span>':(isvir?'<span class="badge">è™šæ‹Ÿ</span>':'')}`;
    s.addEventListener('click',onPillClick); return s;
  };
  function renderUsers(realList){
    // åˆå¹¶ï¼šè™šæ‹Ÿ + çœŸå®ï¼›æŒ‰ uid å»é‡ï¼ˆä¼˜å…ˆçœŸå®ï¼‰
    const map=new Map();
    // å…ˆæ”¾è™šæ‹Ÿ
    VIRTUAL_USERS.forEach(v=> map.set(v.uid, v));
    // å†æ”¾çœŸå®ï¼ˆè¦†ç›–è™šæ‹Ÿï¼‰
    realList.forEach(r=> map.set(r.uid||r.id, {...r, uid:(r.uid||r.id)}));
    const merged=[...map.values()];

    el.users.innerHTML='';
    merged.forEach(u=> el.users.appendChild(pill(u)));

    // è®¾ç½® @ç®¡ç†å‘˜ æŒ‰é’®æ–‡æ¡ˆï¼ˆå–åœ¨çº¿çš„çœŸå®ç®¡ç†å‘˜ï¼Œå¦åˆ™ä¿æŒâ€œç®¡ç†å‘˜â€ï¼‰
    const found = realList.find(u=>adminUIDs.includes(u.uid||u.id));
    adminDisplay.uid = found?.uid || adminUIDs[0] || null;
    adminDisplay.nickname = found?.nickname || 'ç®¡ç†å‘˜';
    el.chipAdmin.textContent = '@'+adminDisplay.nickname;
  }

  // åˆå¹¶æ¶ˆæ¯æµ
  const feed=new Map();
  function renderFeed(){
    const arr=[...feed.values()].sort((a,b)=>{
      const ta=(a.createdAt?.seconds||0)*1e3+(a.createdAt?.nanoseconds||0)/1e6;
      const tb=(b.createdAt?.seconds||0)*1e3+(b.createdAt?.nanoseconds||0)/1e6;
      return ta-tb;
    });
    el.msgs.innerHTML='';
    arr.forEach(m=>{
      const mine=m.from?.uid===me.uid;
      const wrap=document.createElement('div'); wrap.className='bubble'+(mine?' mebubble':'')+(m.isPrivate?' priv':'');
      const name=document.createElement('span'); name.className=nameClass(m.from?.uid, m.from?.gender); name.textContent='@'+(m.from?.nickname||'æœªçŸ¥'); name.style.cursor='pointer';
      name.dataset.uid=m.from?.uid||''; name.dataset.nick=m.from?.nickname||'';
      name.addEventListener('click',()=>{ const uid=name.dataset.uid, nick=name.dataset.nick; if(uid&&uid!==me.uid){ dmTarget={uid,nickname:nick}; el.dmchk.checked=!!m.isPrivate; updateSendTo(); }});
      const from=document.createElement('div'); from.className='from'; from.appendChild(name);
      const b=document.createElement('div'); b.className='b'; b.innerHTML=(m.text||'').replace(/@([\u4e00-\u9fa5\w]+)/g,'<strong>@$1</strong>');
      wrap.appendChild(from); wrap.appendChild(b); el.msgs.appendChild(wrap);
    });
    el.msgs.scrollTop=el.msgs.scrollHeight;
  }

  async function postSystemNotice(text){
    try{ await addDoc(collection(db,'messages'), {from:{uid:'system',nickname:'ç³»ç»Ÿ',gender:'unset'}, isPrivate:false, text:`ã€ç³»ç»Ÿã€‘${text}`, createdAt:serverTimestamp()}); }catch(_){}
  }

  async function claimNicknameAuto(base, uid){
    const tryName=async(name)=>{ const r=doc(db,'nicknames',name); const s=await getDoc(r); if(s.exists()) return false; await setDoc(r,{uid}); return true; };
    try{ let n=1, fin=base, ok=await tryName(fin); while(!ok && n<50){ n++; fin=`${base}_${n}`; ok=await tryName(fin);} return fin; }catch(_){ return base; }
  }

  // å‘é€
  async function send(){
    const text=el.input.value.trim(); if(!text||!me?.uid) return;
    try{
      if(el.dmchk.checked && dmTarget?.uid){
        const parties=me.uid < dmTarget.uid ? [me.uid, dmTarget.uid] : [dmTarget.uid, me.uid];
        await addDoc(collection(db,'dm'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, parties, isPrivate:true, text, createdAt:serverTimestamp() });
      }else{
        const t=(dmTarget && !el.dmchk.checked)?`@${dmTarget.nickname} ${text}`:text;
        await addDoc(collection(db,'messages'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, isPrivate:false, text:t, createdAt:serverTimestamp() });
      }
      el.input.value='';
    }catch(e){ postSystemNotice(`å‘é€å¤±è´¥ï¼š${e.code||e.message||e}`); }
  }
  el.send.onclick=send;
  el.input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
  el.dmchk.addEventListener('change',updateSendTo);

  // @ç®¡ç†å‘˜ å¿«æ·
  el.chipAdmin.addEventListener('click',()=>{
    const at='@'+(adminDisplay.nickname||'ç®¡ç†å‘˜')+' ';
    if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value;
    el.input.focus();
  });

  // ç®¡ç†å‘˜ç™»å½•/é€€å‡º
  el.adminLoginBtn.onclick = async () => {
    const email = (el.adminEmail.value||'').trim();
    const pass  = el.adminPass.value||'';
    if(!email || !pass){ setStatus('err','è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç '); return; }
    try{ await signInWithEmailAndPassword(auth, email, pass); setStatus('ok','ç®¡ç†å‘˜ç™»å½•æˆåŠŸ'); }
    catch(e){ setStatus('err','ç™»å½•å¤±è´¥ï¼š'+(e.message||e)); }
  };
  el.adminLogoutBtn.onclick = async () => {
    try{ await signOut(auth); setStatus('ok','å·²é€€å‡ºç™»å½•'); }
    catch(e){ setStatus('err','é€€å‡ºå¤±è´¥ï¼š'+(e.message||e)); }
  };

  // ç™»å½• & åˆå§‹åŒ–
  signInAnonymously(auth).catch(e=> setStatus('err','åŒ¿åç™»å½•å¤±è´¥ï¼š'+e.message));

  onAuthStateChanged(auth, async (u)=>{
    if(!u) return;
    me.uid=u.uid;

    // è¯»å–/åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ
    const userRef = doc(db,'users',me.uid);
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      const d = snap.data();
      me.nickname = d.nickname || me.nickname;
      me.gender   = d.gender   || me.gender;
    } else {
      const males=['é˜¿å¼º','å»ºå›½','ä¸€é¸£','å­è½©','å¿—è¿œ','æµ©ç„¶']; const females=['ç¾ç³','å¯æ¬£','è¯­æ¡','å˜‰æ€¡','è‹¥å…°','æ¬£æ€¡']; const rnd=a=>a[Math.floor(Math.random()*a.length)];
      let g=Math.random()<.5?'male':'female'; let base=(g==='male'?rnd(males):rnd(females))+Math.floor(Math.random()*90+10);
      const finalNick=await claimNicknameAuto(base, me.uid);
      await setDoc(userRef, { uid:me.uid, nickname:finalNick, gender:g, createdAt:serverTimestamp(), lastSeenAt:serverTimestamp(), roles:['user'], blocked:false }, {merge:true});
      me.nickname=finalNick; me.gender=g;
    }
    el.meNick.textContent='@'+me.nickname; el.meNick.className=nameClass(me.uid, me.gender); el.meRole.textContent='user';

    // ç™½åå•ï¼ˆç®¡ç†å‘˜ï¼‰
    onSnapshot(doc(db,'meta','admins'), snap=>{
      adminUIDs = Array.isArray(snap.data()?.uids) ? snap.data().uids : [];
      amAdmin = adminUIDs.includes(me.uid);
      el.meRole.textContent = amAdmin ? 'admin' : 'user';
      el.adminBar.style.display = amAdmin ? 'flex' : 'none';
      // ç™»å½•è¡Œéšè—/é€€å‡ºè¡Œæ˜¾ç¤ºï¼šè¦æ±‚â€œæ˜¯ç™½åå•ç®¡ç†å‘˜ä¸”ä»¥å¯†ç æ–¹å¼ç™»å½•â€
      const isPassword = (auth.currentUser?.providerData||[]).some(p=>p.providerId==='password');
      el.adminLoginRow.style.display = (amAdmin && isPassword) ? 'none' : 'flex';
      el.adminLogoutRow.style.display = (amAdmin && isPassword) ? 'flex' : 'none';
    });

    // å…¬èŠ
    onSnapshot(query(collection(db,'messages'), orderBy('createdAt','asc')), snap=>{
      snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('pub-'+ch.doc.id, ch.doc.data()); });
      renderFeed();
    });

    // ç§èŠè®¢é˜…ï¼ˆé»˜è®¤ï¼šåªè®¢é˜…åŒ…å«æˆ‘ï¼›ç®¡ç†å‘˜æ¨¡å¼ï¼šè®¢é˜…å…¨éƒ¨ï¼‰
    function subDm(){
      if (unsubDm) unsubDm();
      if (amAdmin && el.adminAll.checked){
        unsubDm = onSnapshot(query(collection(db,'dm'), orderBy('createdAt','asc')), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }else{
        unsubDm = onSnapshot(query(collection(db,'dm'), where('parties','array-contains', me.uid)), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }
    }
    el.adminAll?.addEventListener('change', ()=>{ if(!amAdmin){ el.adminAll.checked=false; return;} subDm(); });
    subDm();

    // åœ¨çº¿ç”¨æˆ·ï¼ˆçœŸå®ï¼‰
    onSnapshot(query(collection(db,'users'), orderBy('createdAt','asc')), s=>{
      const arr=[]; s.forEach(d=> arr.push({ ...d.data(), uid:d.id })); renderUsers(arr);
    });

    setStatus('ok','å·²å°±ç»ª');
  });

  window.addEventListener('online', ()=>setStatus('ok','ç½‘ç»œå·²æ¢å¤'));
  window.addEventListener('offline', ()=>setStatus('err','ç½‘ç»œä¸å¯ç”¨'));

  // ä¿å­˜æ¡£æ¡ˆ
  $('saveProfile').onclick = async ()=>{
    const desired=el.nickInput.value.trim(); const gender=el.genderInput.value||'unset';
    let finalName=me.nickname;
    if(desired && desired!==me.nickname) finalName=await claimNicknameAuto(desired, me.uid);
    try{
      await setDoc(doc(db,'users',me.uid), { uid:me.uid, nickname:finalName, gender, lastSeenAt:serverTimestamp(), roles:me.roles||['user'], blocked:false }, {merge:true});
      me.nickname=finalName; me.gender=gender; el.meNick.textContent='@'+me.nickname; el.meNick.className=nameClass(me.uid, me.gender); updateSendTo();
    }catch(_){}
  };
</script>
</body>
</html>
