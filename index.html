<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>中文聊天室 · 公聊 + 私聊（同屏高亮）</title>
<style>
  :root{--fg:#0f172a;--muted:#6b7280;--line:#e5e7eb;--bg:#f8fafc;--card:#fff;--male:#2563eb;--female:#d946ef;--unset:#64748b;--shadow:0 8px 24px rgba(2,6,23,.06)}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);background:#f8fafc}
  header{padding:14px 18px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:9}.brand{font-size:16px;font-weight:700}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
  .left{padding:14px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 110px)}
  .me{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fbfbfb}
  .me .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:#6b7280;background:#fff}
  .male{color:#2563eb}.female{color:#d946ef}.unset{color:#64748b}
  .ipt{width:100%;border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn.primary{border-color:#111;color:#111;background:#fff}.btn:active{transform:translateY(1px)}
  .list{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin:4px 6px 4px 0;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .badge{font-size:10px;border:1px solid var(--line);border-radius:999px;padding:0 6px;color:#6b7280;background:#fff}
  .grp{font-size:12px;color:#6b7280;margin:2px 0 6px 2px}
  .right{display:grid;grid-template-rows:auto 1fr auto auto;gap:10px;padding:14px;height:calc(100vh - 110px)}
  .mode{color:#6b7280;font-size:12px}
  .msgs{overflow:auto;border:1px solid var(--line);border-radius:12px;background:#ffffff}
  .bubble{margin:10px 12px;max-width:78%}
  .from{font-size:12px;margin-bottom:4px}
  .b{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#f5f7fb}
  .mebubble .b{background:#eef2ff;border-color:#c7d2fe}
  .priv .b{background:#f6f0ff;border-color:#e9d5ff}
  .priv .from::before{content:"🔒 ";}
  .row{display:flex;gap:10px;align-items:center}
  textarea{flex:1;min-height:56px;resize:vertical;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .hint{color:#6b7280;font-size:12px}
  .status{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;margin:10px auto 0;max-width:1200px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);box-shadow:var(--shadow);background:#ffffffcc;backdrop-filter:saturate(180%) blur(8px)}
  .status .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;animation:bl 1.2s infinite}.status.ok .dot{background:#10b981}.status.err .dot{background:#ef4444}
  @keyframes bl{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
</style>
</head>
<body>
<header><div class="brand">中文聊天室 · 公聊 + 私聊（同屏高亮）</div></header>
<div id="status" class="status"><span class="dot"></span><span id="statusText">正在连接 Firebase…</span></div>

<div class="wrap">
  <aside class="card left">
    <div class="me">
      <div class="row"><span>我：<strong id="meNick" class="unset">@guest</strong></span><span id="meRole" class="tag">user</span></div>
      <div class="row" style="justify-content:flex-end"><button class="btn" id="saveProfile">保存</button></div>
      <div class="row">
        <input id="nickInput" class="ipt" placeholder="昵称（唯一，可选）"/>
        <select id="genderInput" class="ipt" style="max-width:120px">
          <option value="unset">未设置</option><option value="male">male</option><option value="female">female</option>
        </select>
        <button class="btn" id="clearDM">清空私聊对象</button>
      </div>
    </div>
    <div class="grp">在线用户</div>
    <div id="users" class="list"></div>
    <div class="grp">示例账号（本地，不占后端）</div>
    <div id="samples" class="list" style="min-height:70px"></div>
  </aside>

  <main class="card right">
    <div id="mode" class="mode">频道：#general（私聊同屏高亮，仅双方可见）</div>
    <div id="msgs" class="msgs"></div>
    <div class="row">
      <label class="hint" style="display:flex;align-items:center;gap:8px">
        <input id="dmchk" type="checkbox" checked />
        私聊打勾（勾选=仅双方可见；不勾选=发到公屏并自动 @）
      </label>
    </div>
    <div class="row">
      <textarea id="input" placeholder="输入消息…  Enter 发送；Shift+Enter 换行"></textarea>
      <button id="send" class="btn primary">发送</button>
    </div>
    <div class="chips">
      <span class="chip" data-at="@系统通知">@系统通知</span>
      <span class="chip" data-at="@管理员A">@管理员A</span>
      <span class="chip" data-at="@访客B">@访客B</span>
    </div>
  </main>
</div>

<script type="module">
  // ===== 状态条 =====
  const statusBar = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const setStatus = (kind, text, hide)=>{ statusBar.className='status '+(kind||''); statusText.textContent=text||''; statusBar.style.display='flex'; if(hide){ setTimeout(()=>statusBar.style.display='none', hide); } };

  // ===== 只从 firebaseConfig.json 加载配置，并校验 =====
  async function loadConfig(){
    try{
      const r = await fetch('./firebaseConfig.json', {cache:'no-store'});
      if(!r.ok) throw new Error(`读取 firebaseConfig.json 失败（HTTP ${r.status}）`);
      const cfg = await r.json();
      // 简单校验：apiKey/appId 不能是占位/空串
      const bad = (v)=> !v || typeof v!=='string' || /YOUR_|<|>|\s/.test(v) || v.length<10;
      if (bad(cfg.apiKey) || bad(cfg.appId)) throw new Error('配置无效：apiKey/appId 看起来不对（可能是占位值）');
      return cfg;
    }catch(e){
      setStatus('err','配置未加载：'+(e.message||e));
      throw e;
    }
  }
  const cfg = await loadConfig();

  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const app  = initializeApp(cfg);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window.addEventListener('unhandledrejection', ev=>{
    setStatus('err','运行错误：'+(ev.reason?.message||ev.reason||'Unknown'));
  });

  // ===== DOM =====
  const $=id=>document.getElementById(id);
  const el={ meNick:$('meNick'), meRole:$('meRole'), nickInput:$('nickInput'), genderInput:$('genderInput'), saveProfile:$('saveProfile'), clearDM:$('clearDM'), users:$('users'), samples:$('samples'), msgs:$('msgs'), input:$('input'), send:$('send'), dmchk:$('dmchk'), mode:$('mode') };

  let me={ uid:null, nickname:'guest', gender:'unset', roles:['user'] };
  let dmTarget=null;

  const gcls=g=>g==='male'?'male':(g==='female'?'female':'unset');
  const renderMe=()=>{ el.meNick.textContent='@'+(me.nickname||'guest'); el.meNick.className=gcls(me.gender||'unset'); el.meRole.textContent=(me.roles||['user']).includes('admin')?'admin':'user'; el.nickInput.value=me.nickname||''; el.genderInput.value=me.gender||'unset'; };
  const pill=(u,sel=true)=>{ const ad=(u.roles||[]).includes('admin')?'<span class="badge">admin</span>':''; return `<span class="pill ${gcls(u.gender)}" data-uid="${u.uid||''}" data-nick="${u.nickname||''}" data-sel="${sel?1:0}"><strong>@${u.nickname||'未知'}</strong> ${ad}</span>`; };
  function bindPills(c){
    [...c.querySelectorAll('.pill')].forEach(p=>{
      p.onclick=()=>{
        const uid=p.dataset.uid, nick=p.dataset.nick;
        if(!uid){ const at='@'+nick+' '; if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value; el.dmchk.checked=false; dmTarget=null; return; }
        if(uid===me.uid){ el.dmchk.checked=false; dmTarget=null; return; }
        dmTarget={uid,nickname:nick};
      };
    });
  }
  const renderUsers=list=>{ el.users.innerHTML=list.map(pill).join(''); bindPills(el.users); };
  const renderSamples=()=>{ const demo=[{nickname:'系统通知',gender:'unset'},{nickname:'管理员A',gender:'male'},{nickname:'访客B',gender:'female'}]; el.samples.innerHTML=demo.map(x=>pill(x,false)).join(''); bindPills(el.samples); };

  const feed=new Map();
  function renderFeed(){
    const arr=[...feed.values()].sort((a,b)=>((a.createdAt?.seconds||0)-(b.createdAt?.seconds||0))||((a.createdAt?.nanoseconds||0)-(b.createdAt?.nanoseconds||0)));
    el.msgs.innerHTML='';
    arr.forEach(m=>{
      const mine=me && m.from?.uid===me.uid;
      const div=document.createElement('div');
      div.className='bubble'+(mine?' mebubble':'')+(m.isPrivate?' priv':'');
      const who=`<span class="${gcls(m.from?.gender)}">@${m.from?.nickname||'未知'}</span>`;
      const text=(m.text||'').replace(/@([\u4e00-\u9fa5\w]+)/g,'<strong>@$1</strong>');
      div.innerHTML=`<div class="from">${who}</div><div class="b">${text}</div>`;
      el.msgs.appendChild(div);
    });
    el.msgs.scrollTop=el.msgs.scrollHeight;
  }

  async function postSystemNotice(text){
    try{ await addDoc(collection(db,'messages'), {from:{uid:'system',nickname:'系统',gender:'unset'}, isPrivate:false, text:`【系统】${text}`, createdAt:serverTimestamp()}); }catch(_){}
  }

  async function claimNicknameAuto(base, uid){
    const tryName=async(name)=>{ const r=doc(db,'nicknames',name); const s=await getDoc(r); if(s.exists()) return false; await setDoc(r,{uid}); return true; };
    try{ let n=1, fin=base, ok=await tryName(fin); while(!ok && n<50){ n++; fin=`${base}_${n}`; ok=await tryName(fin);} return fin; }catch(_){ return base; }
  }

  async function send(){
    const text=el.input.value.trim(); if(!text||!me?.uid) return;
    try{
      if(el.dmchk.checked && dmTarget?.uid){
        const parties = me.uid < dmTarget.uid ? [me.uid, dmTarget.uid] : [dmTarget.uid, me.uid];
        await addDoc(collection(db,'dm'), {
          from:{uid:me.uid,nickname:me.nickname,gender:me.gender},
          parties, isPrivate:true, text, createdAt:serverTimestamp()
        });
      }else{
        const t=(dmTarget && !el.dmchk.checked)?`@${dmTarget.nickname} ${text}`:text;
        await addDoc(collection(db,'messages'), {
          from:{uid:me.uid,nickname:me.nickname,gender:me.gender},
          isPrivate:false, text:t, createdAt:serverTimestamp()
        });
      }
      el.input.value='';
    }catch(e){ postSystemNotice(`发送失败：${e.code||e.message||e}`); }
  }

  el.send.onclick=send;
  el.input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); } });
  el.clearDM.onclick=()=>{ dmTarget=null; el.dmchk.checked=false; };
  document.querySelectorAll('[data-at]').forEach(c=>c.addEventListener('click',()=>{ const at=c.getAttribute('data-at')+' '; if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value; el.input.focus(); }));
  el.saveProfile.onclick=async ()=>{
    const desired=el.nickInput.value.trim(); const gender=el.genderInput.value;
    let finalName=me.nickname; if(desired&&desired!==me.nickname) finalName=await claimNicknameAuto(desired,me.uid);
    try{ await setDoc(doc(db,'users',me.uid), {uid:me.uid,nickname:finalName,gender,lastSeenAt:serverTimestamp(),roles:me.roles||['user'],blocked:false}, {merge:true}); }catch(_){}
    me.nickname=finalName; me.gender=gender; renderMe();
  };

  // ===== 登录 & 初始化 =====
  import { isSignInWithEmailLink } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"; // 仅为确保模块加载
  signInAnonymously(auth).catch(e=> setStatus('err','匿名登录失败：'+e.message));

  onAuthStateChanged(auth, async (u)=>{
    if(!u) return;
    me.uid=u.uid;

    const males=['阿强','建国','一鸣','子轩','志远','浩然']; const females=['美琳','可欣','语桐','嘉怡','若兰','欣怡']; const rnd=a=>a[Math.floor(Math.random()*a.length)];
    let gender=Math.random()<.5?'male':'female'; let base=(gender==='male'?rnd(males):rnd(females))+Math.floor(Math.random()*90+10);
    const finalNick=await claimNicknameAuto(base, me.uid);

    try{
      await setDoc(doc(db,'users',me.uid), {
        uid:me.uid, nickname:finalNick, gender,
        createdAt:serverTimestamp(), lastSeenAt:serverTimestamp(),
        roles:['user'], blocked:false
      }, {merge:true});
    }catch(_){}

    me.nickname=finalNick; me.gender=gender; renderMe(); renderSamples();

    onSnapshot(query(collection(db,'messages'), orderBy('createdAt','asc')), snap=>{
      snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('pub-'+ch.doc.id, ch.doc.data()); });
      renderFeed();
    });

    onSnapshot(query(collection(db,'dm'), where('parties','array-contains', me.uid)), snap=>{
      snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
      renderFeed();
    });

    try{
      onSnapshot(query(collection(db,'users'), orderBy('createdAt','asc')), s=>{
        const arr=[]; s.forEach(d=>arr.push({ uid:d.id, ...d.data() })); renderUsers(arr);
      });
    }catch(_){}

    setStatus('ok','已就绪',1500);
  });

  window.addEventListener('online', ()=>setStatus('ok','网络已恢复',1200));
  window.addEventListener('offline', ()=>setStatus('err','网络不可用'));
</script>
</body>
</html>
