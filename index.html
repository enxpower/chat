<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆåŒå±é«˜äº®ï¼‰</title>
<style>
  :root{--fg:#0f172a;--muted:#6b7280;--line:#e5e7eb;--bg:#f8fafc;--card:#fff;--male:#2563eb;--female:#d946ef;--unset:#64748b;--shadow:0 8px 24px rgba(2,6,23,.06)}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);background:#f8fafc}
  header{padding:14px 18px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:9}
  .brand{font-size:16px;font-weight:700}
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
  .left{padding:14px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 110px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .me{display:flex;flex-direction:column;gap:8px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fbfbfb}
  .tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:#6b7280;background:#fff}
  .male{color:#2563eb}.female{color:#d946ef}.unset{color:#64748b}
  .ipt{width:100%;border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn.primary{border-color:#111;color:#111;background:#fff}.btn:active{transform:translateY(1px)}
  .list{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin:4px 6px 4px 0;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .badge{font-size:10px;border:1px solid var(--line);border-radius:999px;padding:0 6px;color:#6b7280;background:#fff}
  .grp{font-size:12px;color:#6b7280;margin:2px 0 6px 2px}

  .right{display:grid;grid-template-rows:auto auto 1fr auto auto;gap:10px;padding:14px;height:calc(100vh - 110px)}
  .mode{color:#6b7280;font-size:12px}
  .sendto{color:#374151;font-size:12px}
  .msgs{overflow:auto;border:1px solid var(--line);border-radius:12px;background:#ffffff}
  .bubble{margin:10px 12px;max-width:78%}
  .from{font-size:12px;margin-bottom:4px}
  .b{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#f5f7fb}
  .mebubble .b{background:#eef2ff;border-color:#c7d2fe}
  .priv .b{background:#f6f0ff;border-color:#e9d5ff}
  .priv .from::before{content:"ğŸ”’ ";}

  textarea{flex:1;min-height:56px;resize:vertical;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

  .status{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;margin:10px auto 0;max-width:1200px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);box-shadow:var(--shadow);background:#ffffffcc;backdrop-filter:saturate(180%) blur(8px)}
  .status .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;animation:bl 1.2s infinite}.status.ok .dot{background:#10b981}.status.err .dot{background:#ef4444}
  @keyframes bl{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
</style>
</head>
<body>
<header><div class="brand">ä¸­æ–‡èŠå¤©å®¤ Â· å…¬èŠ + ç§èŠï¼ˆåŒå±é«˜äº®ï¼‰</div></header>
<div id="status" class="status"><span class="dot"></span><span id="statusText">æ­£åœ¨è¿æ¥ Firebaseâ€¦</span></div>

<div class="wrap">
  <!-- å·¦ä¾§ -->
  <aside class="card left">
    <div class="me">
      <div class="row">
        <span>æˆ‘ï¼š<strong id="meNick" class="unset">@guest</strong></span>
        <span id="meRole" class="tag">user</span>
      </div>

      <div class="row" style="gap:6px">
        <span class="tag">UID:</span>
        <input id="uidBox" class="ipt" style="flex:1;min-width:0" readonly />
        <button id="copyUid" class="btn">å¤åˆ¶ UID</button>
      </div>

      <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
      <div class="row" id="adminLoginRow">
        <input id="adminEmail" class="ipt" placeholder="ç®¡ç†å‘˜é‚®ç®±" style="min-width:160px">
        <input id="adminPass" class="ipt" type="password" placeholder="å¯†ç " style="min-width:120px">
        <button class="btn" id="adminLoginBtn">ç™»å½•</button>
        <button class="btn" id="adminLogoutBtn">é€€å‡º</button>
      </div>

      <!-- ç®¡ç†å‘˜æ¨¡å¼å¼€å…³ï¼ˆä»…ç®¡ç†å‘˜æ˜¾ç¤ºï¼‰ -->
      <div id="adminBar" class="row" style="display:none">
        <label style="font-size:12px;color:#374151;display:flex;align-items:center;gap:6px">
          <input id="adminAll" type="checkbox"/>
          ç®¡ç†å‘˜æ¨¡å¼ï¼šæŸ¥çœ‹å…¨éƒ¨ç§èŠï¼ˆé»˜è®¤å…³é—­ï¼‰
        </label>
      </div>

      <!-- æ¡£æ¡ˆè®¾ç½® -->
      <div class="row">
        <input id="nickInput" class="ipt" placeholder="æ˜µç§°ï¼ˆå”¯ä¸€ï¼Œå¯é€‰ï¼‰"/>
        <select id="genderInput" class="ipt" style="max-width:120px">
          <option value="unset">æœªè®¾ç½®</option>
          <option value="male">male</option>
          <option value="female">female</option>
        </select>
        <button class="btn" id="saveProfile">ä¿å­˜</button>
      </div>
      <div class="row"><button class="btn" id="clearDM">æ¸…ç©ºç§èŠå¯¹è±¡</button></div>
    </div>

    <div class="grp">åœ¨çº¿ç”¨æˆ·</div>
    <div id="users" class="list"></div>

    <div class="grp">ç¤ºä¾‹è´¦å·ï¼ˆæœ¬åœ°ï¼Œä¸å åç«¯ï¼‰</div>
    <div id="samples" class="list" style="min-height:70px"></div>
  </aside>

  <!-- å³ä¾§ï¼šå•ä¸€æ¶ˆæ¯æµ -->
  <main class="card right">
    <div id="mode" class="mode">é¢‘é“ï¼š#generalï¼ˆç§èŠåŒå±é«˜äº®ï¼Œä»…åŒæ–¹å¯è§ï¼‰</div>
    <div id="sendto" class="sendto">å°†å‘é€åˆ°ï¼šå…¬å±</div>
    <div id="msgs" class="msgs"></div>

    <div class="row" style="color:#6b7280;font-size:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="dmchk" type="checkbox" checked /> ç§èŠæ‰“å‹¾ï¼ˆå‹¾é€‰=ä»…åŒæ–¹å¯è§ï¼›ä¸å‹¾é€‰=å‘åˆ°å…¬å±å¹¶è‡ªåŠ¨ @ï¼‰
      </label>
    </div>

    <div class="row">
      <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦  Enter å‘é€ï¼›Shift+Enter æ¢è¡Œ"></textarea>
      <button id="send" class="btn primary">å‘é€</button>
    </div>

    <div class="chips">
      <span class="chip" data-at="@ç³»ç»Ÿé€šçŸ¥">@ç³»ç»Ÿé€šçŸ¥</span>
      <span class="chip" data-at="@ç®¡ç†å‘˜A">@ç®¡ç†å‘˜A</span>
      <span class="chip" data-at="@è®¿å®¢B">@è®¿å®¢B</span>
    </div>
  </main>
</div>

<script type="module">
  // ===== çŠ¶æ€æ¡ =====
  const $ = id => document.getElementById(id);
  const statusBar = $('status'), statusText = $('statusText');
  const setStatus = (kind, text, hide)=>{ statusBar.className='status '+(kind||''); statusText.textContent=text||''; statusBar.style.display='flex'; if(hide){ setTimeout(()=>statusBar.style.display='none', hide);} };

  // ===== åªä» firebaseConfig.json è¯»å–é…ç½® =====
  async function loadConfig(){
    try{
      const r = await fetch('./firebaseConfig.json', {cache:'no-store'});
      if(!r.ok) throw new Error(`è¯»å– firebaseConfig.json å¤±è´¥ï¼ˆHTTP ${r.status}ï¼‰`);
      const cfg = await r.json();
      const bad = v => !v || typeof v!=='string' || /YOUR_|<|>|\s/.test(v) || v.length<10;
      if (bad(cfg.apiKey) || bad(cfg.appId)) throw new Error('é…ç½®æ— æ•ˆï¼šapiKey/appId çœ‹èµ·æ¥æ˜¯å ä½å€¼');
      return cfg;
    }catch(e){ setStatus('err','é…ç½®æœªåŠ è½½ï¼š'+(e.message||e)); throw e; }
  }
  const cfg = await loadConfig();

  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  const app = initializeApp(cfg); const auth = getAuth(app); const db = getFirestore(app);

  window.addEventListener('unhandledrejection', ev=> setStatus('err','è¿è¡Œé”™è¯¯ï¼š'+(ev.reason?.message||ev.reason||'Unknown')));

  // ===== DOM refs =====
  const el = {
    users:$('users'), samples:$('samples'), msgs:$('msgs'),
    input:$('input'), send:$('send'), dmchk:$('dmchk'), sendto:$('sendto'),
    meNick:$('meNick'), meRole:$('meRole'), nickInput:$('nickInput'), genderInput:$('genderInput'),
    saveProfile:$('saveProfile'), clearDM:$('clearDM'),
    uidBox:$('uidBox'), copyUid:$('copyUid'), adminBar:$('adminBar'), adminAll:$('adminAll'),
    adminEmail:$('adminEmail'), adminPass:$('adminPass'), adminLoginBtn:$('adminLoginBtn'), adminLogoutBtn:$('adminLogoutBtn')
  };

  // ===== çŠ¶æ€ =====
  let me={ uid:null, nickname:'guest', gender:'unset', roles:['user'] };
  let dmTarget=null;
  let amAdmin=false;
  let unsubDm=null; // å½“å‰ DM è®¢é˜…

  const gcls=g=>g==='male'?'male':(g==='female'?'female':'unset');
  const updateSendTo=()=>{
    if(dmTarget?.uid && el.dmchk.checked){
      el.sendto.textContent=`å°†å‘é€åˆ°ï¼šç§èŠ @${dmTarget.nickname}`;
    }else if(dmTarget?.uid && !el.dmchk.checked){
      el.sendto.textContent=`å°†å‘é€åˆ°ï¼šå…¬å±ï¼ˆå·²é€‰æ‹© @${dmTarget.nickname}ï¼Œè‹¥è¦ç§èŠè¯·å‹¾é€‰ï¼‰`;
    }else{
      el.sendto.textContent='å°†å‘é€åˆ°ï¼šå…¬å±';
    }
  };

  // ===== åœ¨çº¿ç”¨æˆ·æ¸²æŸ“ï¼ˆç¡®ä¿ data-uid ä¸€å®šæœ‰ï¼‰ =====
  function onPillClick(e){
    const p=e.currentTarget; const uid=p.dataset.uid; const nick=p.dataset.nick;
    if(!uid){ // ç¤ºä¾‹è´¦å·ï¼šåª @ ä¸ç§èŠ
      const at='@'+nick+' '; if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value;
      el.dmchk.checked=false; dmTarget=null; updateSendTo(); return;
    }
    if(uid===me.uid){ el.dmchk.checked=false; dmTarget=null; updateSendTo(); return; }
    dmTarget={uid,nickname:nick}; el.dmchk.checked=true; updateSendTo(); // ç‚¹å‡»åœ¨çº¿ç”¨æˆ·é»˜è®¤èµ°ç§èŠ
  }
  const pill=(u)=>{
    const s=document.createElement('span'); s.className='pill '+gcls(u.gender);
    s.dataset.uid=u.uid||''; s.dataset.nick=u.nickname||'';
    const ad=(u.roles||[]).includes('admin')?'<span class="badge">admin</span>':'';
    s.innerHTML=`<strong>@${u.nickname||'æœªçŸ¥'}</strong> ${ad}`; s.addEventListener('click',onPillClick); return s;
  };
  function renderUsers(list){ el.users.innerHTML=''; list.forEach(u=> el.users.appendChild(pill(u))); }
  function renderSamples(){ const demo=[{nickname:'ç³»ç»Ÿé€šçŸ¥',gender:'unset'},{nickname:'ç®¡ç†å‘˜A',gender:'male'},{nickname:'è®¿å®¢B',gender:'female'}]; el.samples.innerHTML=''; demo.forEach(x=>el.samples.appendChild(pill(x))); }

  // ===== åˆå¹¶æ¶ˆæ¯æµï¼šå…¬èŠ + ï¼ˆåŒ…å«æˆ‘ or ç®¡ç†å‘˜æ¨¡å¼ä¸‹çš„å…¨éƒ¨ï¼‰ç§èŠ =====
  const feed=new Map(); // id -> data
  function renderFeed(){
    const arr=[...feed.values()].sort((a,b)=>{
      const ta=(a.createdAt?.seconds||0)*1e3+(a.createdAt?.nanoseconds||0)/1e6;
      const tb=(b.createdAt?.seconds||0)*1e3+(b.createdAt?.nanoseconds||0)/1e6;
      return ta-tb;
    });
    el.msgs.innerHTML='';
    arr.forEach(m=>{
      const mine=m.from?.uid===me.uid;
      const wrap=document.createElement('div'); wrap.className='bubble'+(mine?' mebubble':'')+(m.isPrivate?' priv':'');
      const name=document.createElement('span'); name.className=gcls(m.from?.gender); name.textContent='@'+(m.from?.nickname||'æœªçŸ¥'); name.style.cursor='pointer';
      name.dataset.uid=m.from?.uid||''; name.dataset.nick=m.from?.nickname||'';
      name.addEventListener('click',()=>{ const uid=name.dataset.uid, nick=name.dataset.nick; if(uid&&uid!==me.uid){ dmTarget={uid,nickname:nick}; el.dmchk.checked=!!m.isPrivate; updateSendTo(); }});
      const from=document.createElement('div'); from.className='from'; from.appendChild(name);
      const b=document.createElement('div'); b.className='b'; b.innerHTML=(m.text||'').replace(/@([\u4e00-\u9fa5\w]+)/g,'<strong>@$1</strong>');
      wrap.appendChild(from); wrap.appendChild(b); el.msgs.appendChild(wrap);
    });
    el.msgs.scrollTop=el.msgs.scrollHeight;
  }

  async function postSystemNotice(text){
    try{ await addDoc(collection(db,'messages'), {from:{uid:'system',nickname:'ç³»ç»Ÿ',gender:'unset'}, isPrivate:false, text:`ã€ç³»ç»Ÿã€‘${text}`, createdAt:serverTimestamp()}); }catch(_){}
  }

  async function claimNicknameAuto(base, uid){
    const tryName=async(name)=>{ const r=doc(db,'nicknames',name); const s=await getDoc(r); if(s.exists()) return false; await setDoc(r,{uid}); return true; };
    try{ let n=1, fin=base, ok=await tryName(fin); while(!ok && n<50){ n++; fin=`${base}_${n}`; ok=await tryName(fin);} return fin; }catch(_){ return base; }
  }

  // ===== å‘é€ =====
  async function send(){
    const text=el.input.value.trim(); if(!text||!me?.uid) return;
    try{
      if(el.dmchk.checked && dmTarget?.uid){
        const parties=me.uid < dmTarget.uid ? [me.uid, dmTarget.uid] : [dmTarget.uid, me.uid];
        await addDoc(collection(db,'dm'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, parties, isPrivate:true, text, createdAt:serverTimestamp() });
      }else{
        const t=(dmTarget && !el.dmchk.checked)?`@${dmTarget.nickname} ${text}`:text;
        await addDoc(collection(db,'messages'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, isPrivate:false, text:t, createdAt:serverTimestamp() });
      }
      el.input.value='';
    }catch(e){ postSystemNotice(`å‘é€å¤±è´¥ï¼š${e.code||e.message||e}`); }
  }
  el.send.onclick=send;
  el.input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
  el.dmchk.addEventListener('change',updateSendTo);
  el.clearDM.onclick=()=>{ dmTarget=null; el.dmchk.checked=false; updateSendTo(); };
  document.querySelectorAll('[data-at]').forEach(c=> c.addEventListener('click',()=>{ const at=c.getAttribute('data-at')+' '; if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value; el.input.focus(); }));

  // ===== ç®¡ç†å‘˜ç™»å½• / é€€å‡º =====
  el.adminLoginBtn.onclick = async () => {
    const email = (el.adminEmail.value||'').trim();
    const pass  = el.adminPass.value||'';
    if(!email || !pass){ setStatus('err','è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç '); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      setStatus('ok','ç®¡ç†å‘˜ç™»å½•æˆåŠŸ',1200);
    }catch(e){ setStatus('err','ç™»å½•å¤±è´¥ï¼š'+(e.message||e)); }
  };
  el.adminLogoutBtn.onclick = async () => {
    try{ await signOut(auth); setStatus('ok','å·²é€€å‡ºç™»å½•',1200); }
    catch(e){ setStatus('err','é€€å‡ºå¤±è´¥ï¼š'+(e.message||e)); }
  };

  // ===== ç™»å½• & åˆå§‹åŒ– =====
  signInAnonymously(auth).catch(e=> setStatus('err','åŒ¿åç™»å½•å¤±è´¥ï¼š'+e.message));

  onAuthStateChanged(auth, async (u)=>{
    if(!u) return;
    me.uid=u.uid;

    // æ˜¾ç¤º UID
    el.uidBox.value = me.uid;
    el.copyUid.onclick = ()=>{ navigator.clipboard.writeText(me.uid).then(()=>{el.copyUid.textContent='å·²å¤åˆ¶'; setTimeout(()=>el.copyUid.textContent='å¤åˆ¶ UID',1200);}); };

    // è¯»å–/åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆï¼šè‹¥å·²æœ‰åˆ™ç”¨å·²æœ‰ï¼›è‹¥æ— åˆ™åˆ›å»ºé»˜è®¤
    const userRef = doc(db,'users',me.uid);
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      const d = snap.data();
      me.nickname = d.nickname || me.nickname;
      me.gender   = d.gender   || me.gender;
    } else {
      const males=['é˜¿å¼º','å»ºå›½','ä¸€é¸£','å­è½©','å¿—è¿œ','æµ©ç„¶']; const females=['ç¾ç³','å¯æ¬£','è¯­æ¡','å˜‰æ€¡','è‹¥å…°','æ¬£æ€¡']; const rnd=a=>a[Math.floor(Math.random()*a.length)];
      let gender=Math.random()<.5?'male':'female'; let base=(gender==='male'?rnd(males):rnd(females))+Math.floor(Math.random()*90+10);
      const finalNick=await claimNicknameAuto(base, me.uid);
      await setDoc(userRef, { uid:me.uid, nickname:finalNick, gender, createdAt:serverTimestamp(), lastSeenAt:serverTimestamp(), roles:['user'], blocked:false }, {merge:true});
      me.nickname=finalNick; me.gender=gender;
    }
    // æ¸²æŸ“â€œæˆ‘â€
    el.meNick.textContent='@'+me.nickname; el.meNick.className=gcls(me.gender); el.meRole.textContent='user';
    renderSamples(); updateSendTo();

    // è®¢é˜…ç®¡ç†å‘˜ç™½åå•ï¼Œåˆ¤æ–­æ˜¯å¦ç®¡ç†å‘˜
    onSnapshot(doc(db,'meta','admins'), snap=>{
      const uids=(snap.data()?.uids)||[];
      amAdmin = Array.isArray(uids) && uids.includes(me.uid);
      el.meRole.textContent = amAdmin ? 'admin' : 'user';
      el.adminBar.style.display = amAdmin ? 'flex' : 'none';
    });

    // å…¬èŠ
    onSnapshot(query(collection(db,'messages'), orderBy('createdAt','asc')), snap=>{
      snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('pub-'+ch.doc.id, ch.doc.data()); });
      renderFeed();
    });

    // ç§èŠè®¢é˜…ï¼ˆé»˜è®¤ï¼šåªè®¢é˜…åŒ…å«æˆ‘ï¼›ç®¡ç†å‘˜æ¨¡å¼ï¼šè®¢é˜…å…¨éƒ¨ï¼‰
    function subDm(){
      if (unsubDm) unsubDm();
      if (amAdmin && el.adminAll.checked){
        unsubDm = onSnapshot(query(collection(db,'dm'), orderBy('createdAt','asc')), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }else{
        unsubDm = onSnapshot(query(collection(db,'dm'), where('parties','array-contains', me.uid)), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }
    }
    el.adminAll?.addEventListener('change', ()=>{ if(!amAdmin){ el.adminAll.checked=false; return;} subDm(); });
    subDm(); // åˆå§‹è®¢é˜…

    // åœ¨çº¿ç”¨æˆ·ï¼ˆâ˜… uid ç”¨ doc.id è¦†ç›–ï¼‰
    onSnapshot(query(collection(db,'users'), orderBy('createdAt','asc')), s=>{
      const arr=[]; s.forEach(d=> arr.push({ ...d.data(), uid:d.id })); renderUsers(arr);
    });

    setStatus('ok','å·²å°±ç»ª',1500);
  });

  window.addEventListener('online', ()=>setStatus('ok','ç½‘ç»œå·²æ¢å¤',1200));
  window.addEventListener('offline', ()=>setStatus('err','ç½‘ç»œä¸å¯ç”¨'));

  // ä¿å­˜æ¡£æ¡ˆ
  $('saveProfile').onclick = async ()=>{
    const desired=el.nickInput.value.trim(); const gender=el.genderInput.value||'unset';
    let finalName=me.nickname;
    if(desired && desired!==me.nickname) finalName=await claimNicknameAuto(desired, me.uid);
    try{
      await setDoc(doc(db,'users',me.uid), { uid:me.uid, nickname:finalName, gender, lastSeenAt:serverTimestamp(), roles:me.roles||['user'], blocked:false }, {merge:true});
      me.nickname=finalName; me.gender=gender; el.meNick.textContent='@'+me.nickname; el.meNick.className=gcls(me.gender);
    }catch(_){}
  };
</script>
</body>
</html>
