<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>中文聊天室 · 公聊 + 私聊（同屏高亮）</title>
<style>
  :root{--fg:#0f172a;--muted:#6b7280;--line:#e5e7eb;--bg:#f8fafc;--card:#fff;--male:#2563eb;--female:#d946ef;--unset:#64748b;--admin:#f97316;--shadow:0 8px 24px rgba(2,6,23,.06)}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);background:#f8fafc}
  header{padding:14px 18px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:9}
  .brand{font-size:16px;font-weight:700}

  .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}

  .left{padding:14px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 110px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .me{display:flex;flex-direction:column;gap:10px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fbfbfb}
  .tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:#6b7280;background:#fff}

  .male{color:#2563eb}.female{color:#d946ef}.unset{color:#64748b}.adminname{color:var(--admin)!important}
  .ipt{width:100%;border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn.primary{border-color:#111;color:#111;background:#fff}.btn:active{transform:translateY(1px)}

  .list{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin:4px 6px 4px 0;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .badge{font-size:10px;border:1px solid var(--line);border-radius:999px;padding:0 6px;color:#6b7280;background:#fff}
  .grp{font-size:12px;color:#6b7280;margin:2px 0 6px 2px}

  .right{display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;padding:14px;height:calc(100vh - 110px)}
  .mode{color:#6b7280;font-size:12px}
  .msgs{overflow:auto;border:1px solid var(--line);border-radius:12px;background:#ffffff}
  .sendto{color:#374151;font-size:12px;padding:2px 6px}
  .sendto strong{color:#111}

  .bubble{margin:10px 12px;max-width:78%}
  .from{font-size:12px;margin-bottom:4px}
  .b{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#f5f7fb}
  .mebubble .b{background:#eef2ff;border-color:#c7d2fe}
  .priv .b{background:#f6f0ff;border-color:#e9d5ff}
  .priv .from::before{content:"🔒 ";}

  textarea{flex:1;min-height:56px;resize:vertical;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

  .status{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;margin:10px auto 0;max-width:1200px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);box-shadow:var(--shadow);background:#ffffffcc;backdrop-filter:saturate(180%) blur(8px)}
  .status .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;animation:bl 1.2s infinite}.status.ok .dot{background:#10b981}.status.err .dot{background:#ef4444}
  @keyframes bl{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
</style>
</head>
<body>
<header><div class="brand">中文聊天室 · 公聊 + 私聊（同屏高亮）</div></header>
<div id="status" class="status"><span class="dot"></span><span id="statusText">正在连接 Firebase…</span></div>

<div class="wrap">
  <!-- 左侧 -->
  <aside class="card left">
    <div class="me">
      <div class="row">
        <span>我：<strong id="meNick" class="unset">@guest</strong></span>
        <span id="meRole" class="tag">user</span>
      </div>

      <!-- 管理员登录（登录后隐藏；只留退出） -->
      <div class="row" id="adminLoginRow">
        <input id="adminEmail" class="ipt" placeholder="管理员邮箱" style="min-width:160px">
        <input id="adminPass" class="ipt" type="password" placeholder="密码" style="min-width:120px">
        <button class="btn" id="adminLoginBtn">登录</button>
      </div>
      <div class="row" id="adminLogoutRow" style="display:none">
        <button class="btn" id="adminLogoutBtn">退出管理员</button>
      </div>

      <!-- 管理员模式开关（仅管理员显示） -->
      <div id="adminBar" class="row" style="display:none">
        <label style="font-size:12px;color:#374151;display:flex;align-items:center;gap:6px">
          <input id="adminAll" type="checkbox"/>
          管理员模式：查看全部私聊（默认关闭）
        </label>
      </div>

      <!-- 档案设置 -->
      <div class="row">
        <input id="nickInput" class="ipt" placeholder="昵称（唯一，可选）"/>
        <select id="genderInput" class="ipt" style="max-width:120px">
          <option value="unset">未设置</option>
          <option value="male">male</option>
          <option value="female">female</option>
        </select>
        <button class="btn" id="saveProfile">保存</button>
      </div>
    </div>

    <div class="grp">在线用户</div>
    <div id="users" class="list"></div>
  </aside>

  <!-- 右侧：单一消息流 -->
  <main class="card right">
    <div id="mode" class="mode">频道：#general（私聊同屏高亮，仅双方可见）</div>
    <div id="msgs" class="msgs"></div>

    <!-- 将发送到： 放在输入框上方 -->
    <div id="sendto" class="sendto">将发送到：<strong>公屏</strong></div>

    <div class="row" style="color:#6b7280;font-size:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="dmchk" type="checkbox" checked /> 私聊打勾（勾选=仅双方可见；不勾选=发到公屏并自动 @）
      </label>
    </div>

    <div class="row">
      <textarea id="input" placeholder="输入消息…  Enter 发送；Shift+Enter 换行"></textarea>
      <button id="send" class="btn primary">发送</button>
    </div>

    <!-- 仅保留 @管理员 快捷按钮（名字动态使用白名单管理员；管理员名称有专属颜色） -->
    <div class="chips">
      <span class="chip" id="chipAdmin">@管理员</span>
    </div>
  </main>
</div>

<script type="module">
  // ===== 常驻状态条 =====
  const $ = id => document.getElementById(id);
  const statusText = $('statusText');
  const setStatus = (kind, text)=>{ const bar=document.getElementById('status'); bar.className='status '+(kind||''); statusText.textContent=text||''; bar.style.display='flex'; };

  // ===== 只从 firebaseConfig.json 读取配置 =====
  async function loadConfig(){
    const r = await fetch('./firebaseConfig.json', {cache:'no-store'});
    if(!r.ok) throw new Error(`读取 firebaseConfig.json 失败（HTTP ${r.status}）`);
    const cfg = await r.json();
    const bad = v => !v || typeof v!=='string' || /YOUR_|<|>|\s/.test(v) || v.length<10;
    if (bad(cfg.apiKey) || bad(cfg.appId)) throw new Error('配置无效：apiKey/appId 似乎是占位值');
    return cfg;
  }
  const cfg = await loadConfig();

  // ===== Firebase SDK =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, serverTimestamp, doc, getDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  const app = initializeApp(cfg); const auth = getAuth(app); const db = getFirestore(app);

  window.addEventListener('unhandledrejection', ev=> setStatus('err','运行错误：'+(ev.reason?.message||ev.reason||'Unknown')));

  // ===== 配置：虚拟在线用户（女性） =====
  // 在这里增删即可。uid 以 v_ 开头，避免与真实用户冲突。
  const VIRTUAL_USERS = [
    { uid:'v_f01', nickname:'美琳33', gender:'female' },
    { uid:'v_f02', nickname:'语桐27', gender:'female' },
    { uid:'v_f03', nickname:'嘉怡45', gender:'female' },
    { uid:'v_f04', nickname:'若兰29', gender:'female' },
    { uid:'v_f05', nickname:'欣怡38', gender:'female' }
  ];

  // ===== DOM refs =====
  const el = {
    users:$('users'), msgs:$('msgs'),
    input:$('input'), send:$('send'), dmchk:$('dmchk'), sendto:$('sendto'),
    meNick:$('meNick'), meRole:$('meRole'), nickInput:$('nickInput'), genderInput:$('genderInput'),
    saveProfile:$('saveProfile'),
    adminBar:$('adminBar'), adminAll:$('adminAll'),
    adminLoginRow:$('adminLoginRow'), adminLogoutRow:$('adminLogoutRow'),
    adminEmail:$('adminEmail'), adminPass:$('adminPass'), adminLoginBtn:$('adminLoginBtn'), adminLogoutBtn:$('adminLogoutBtn'),
    chipAdmin:$('chipAdmin')
  };

  // ===== 状态 =====
  let me={ uid:null, nickname:'guest', gender:'unset', roles:['user'] };
  let dmTarget=null;
  let amAdmin=false;
  let adminUIDs=[];                        // 白名单管理员 UID 列表
  let adminDisplay = { uid:null, nickname:'管理员' }; // 用于 @管理员 快捷按钮
  let unsubDm=null;

  // 颜色类：管理员 > 性别 > 未设
  const nameClass=(uid, gender)=>{
    if (adminUIDs.includes(uid)) return 'adminname';
    if ((uid||'').startsWith('v_')) return 'female'; // 虚拟女性统一按女性色
    return gender==='male'?'male':(gender==='female'?'female':'unset');
  };

  const updateSendTo=()=>{
    if(dmTarget?.uid && el.dmchk.checked){
      el.sendto.innerHTML=`将发送到：<strong class="${nameClass(dmTarget.uid,'unset')}">@${dmTarget.nickname}</strong>（私聊）`;
    }else if(dmTarget?.uid && !el.dmchk.checked){
      el.sendto.innerHTML=`将发送到：<strong>公屏</strong>（已选择 <span class="${nameClass(dmTarget.uid,'unset')}">@${dmTarget.nickname}</span>，若要私聊请勾选）`;
    }else{
      el.sendto.innerHTML='将发送到：<strong>公屏</strong>';
    }
  };

  // 在线用户
  function onPillClick(e){
    const p=e.currentTarget; const uid=p.dataset.uid; const nick=p.dataset.nick;
    if(!uid || uid===me.uid){ el.dmchk.checked=false; dmTarget=null; updateSendTo(); return; }
    dmTarget={uid,nickname:nick}; el.dmchk.checked=true; updateSendTo();
  }
  const pill=(u)=>{
    const s=document.createElement('span'); s.className='pill '+nameClass(u.uid,u.gender);
    s.dataset.uid=u.uid||''; s.dataset.nick=u.nickname||'';
    const isadm = adminUIDs.includes(u.uid);
    const isvir = false; // 或者保留原判断但在下一行模板里不用它;
    s.innerHTML=`<strong>@${u.nickname||'未知'}</strong> ${isadm?'<span class="badge">admin</span>':(isvir?'<span class="badge">虚拟</span>':'')}`;
    s.addEventListener('click',onPillClick); return s;
  };
  function renderUsers(realList){
    // 合并：虚拟 + 真实；按 uid 去重（优先真实）
    const map=new Map();
    // 先放虚拟
    VIRTUAL_USERS.forEach(v=> map.set(v.uid, v));
    // 再放真实（覆盖虚拟）
    realList.forEach(r=> map.set(r.uid||r.id, {...r, uid:(r.uid||r.id)}));
    const merged=[...map.values()];

    el.users.innerHTML='';
    merged.forEach(u=> el.users.appendChild(pill(u)));

    // 设置 @管理员 按钮文案（取在线的真实管理员，否则保持“管理员”）
    const found = realList.find(u=>adminUIDs.includes(u.uid||u.id));
    adminDisplay.uid = found?.uid || adminUIDs[0] || null;
    adminDisplay.nickname = found?.nickname || '管理员';
    el.chipAdmin.textContent = '@'+adminDisplay.nickname;
  }

  // 合并消息流
  const feed=new Map();
  function renderFeed(){
    const arr=[...feed.values()].sort((a,b)=>{
      const ta=(a.createdAt?.seconds||0)*1e3+(a.createdAt?.nanoseconds||0)/1e6;
      const tb=(b.createdAt?.seconds||0)*1e3+(b.createdAt?.nanoseconds||0)/1e6;
      return ta-tb;
    });
    el.msgs.innerHTML='';
    arr.forEach(m=>{
      const mine=m.from?.uid===me.uid;
      const wrap=document.createElement('div'); wrap.className='bubble'+(mine?' mebubble':'')+(m.isPrivate?' priv':'');
      const name=document.createElement('span'); name.className=nameClass(m.from?.uid, m.from?.gender); name.textContent='@'+(m.from?.nickname||'未知'); name.style.cursor='pointer';
      name.dataset.uid=m.from?.uid||''; name.dataset.nick=m.from?.nickname||'';
      name.addEventListener('click',()=>{ const uid=name.dataset.uid, nick=name.dataset.nick; if(uid&&uid!==me.uid){ dmTarget={uid,nickname:nick}; el.dmchk.checked=!!m.isPrivate; updateSendTo(); }});
      const from=document.createElement('div'); from.className='from'; from.appendChild(name);
      const b=document.createElement('div'); b.className='b'; b.innerHTML=(m.text||'').replace(/@([\u4e00-\u9fa5\w]+)/g,'<strong>@$1</strong>');
      wrap.appendChild(from); wrap.appendChild(b); el.msgs.appendChild(wrap);
    });
    el.msgs.scrollTop=el.msgs.scrollHeight;
  }

  async function postSystemNotice(text){
    try{ await addDoc(collection(db,'messages'), {from:{uid:'system',nickname:'系统',gender:'unset'}, isPrivate:false, text:`【系统】${text}`, createdAt:serverTimestamp()}); }catch(_){}
  }

  async function claimNicknameAuto(base, uid){
    const tryName=async(name)=>{ const r=doc(db,'nicknames',name); const s=await getDoc(r); if(s.exists()) return false; await setDoc(r,{uid}); return true; };
    try{ let n=1, fin=base, ok=await tryName(fin); while(!ok && n<50){ n++; fin=`${base}_${n}`; ok=await tryName(fin);} return fin; }catch(_){ return base; }
  }

  // 发送
  async function send(){
    const text=el.input.value.trim(); if(!text||!me?.uid) return;
    try{
      if(el.dmchk.checked && dmTarget?.uid){
        const parties=me.uid < dmTarget.uid ? [me.uid, dmTarget.uid] : [dmTarget.uid, me.uid];
        await addDoc(collection(db,'dm'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, parties, isPrivate:true, text, createdAt:serverTimestamp() });
      }else{
        const t=(dmTarget && !el.dmchk.checked)?`@${dmTarget.nickname} ${text}`:text;
        await addDoc(collection(db,'messages'), { from:{uid:me.uid,nickname:me.nickname,gender:me.gender}, isPrivate:false, text:t, createdAt:serverTimestamp() });
      }
      el.input.value='';
    }catch(e){ postSystemNotice(`发送失败：${e.code||e.message||e}`); }
  }
  el.send.onclick=send;
  el.input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
  el.dmchk.addEventListener('change',updateSendTo);

  // @管理员 快捷
  el.chipAdmin.addEventListener('click',()=>{
    const at='@'+(adminDisplay.nickname||'管理员')+' ';
    if(!el.input.value.startsWith(at)) el.input.value=at+el.input.value;
    el.input.focus();
  });

  // 管理员登录/退出
  el.adminLoginBtn.onclick = async () => {
    const email = (el.adminEmail.value||'').trim();
    const pass  = el.adminPass.value||'';
    if(!email || !pass){ setStatus('err','请输入邮箱与密码'); return; }
    try{ await signInWithEmailAndPassword(auth, email, pass); setStatus('ok','管理员登录成功'); }
    catch(e){ setStatus('err','登录失败：'+(e.message||e)); }
  };
  el.adminLogoutBtn.onclick = async () => {
    try{ await signOut(auth); setStatus('ok','已退出登录'); }
    catch(e){ setStatus('err','退出失败：'+(e.message||e)); }
  };

  // 登录 & 初始化
  signInAnonymously(auth).catch(e=> setStatus('err','匿名登录失败：'+e.message));

  onAuthStateChanged(auth, async (u)=>{
    if(!u) return;
    me.uid=u.uid;

    // 读取/创建用户档案
    const userRef = doc(db,'users',me.uid);
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      const d = snap.data();
      me.nickname = d.nickname || me.nickname;
      me.gender   = d.gender   || me.gender;
    } else {
      const males=['阿强','建国','一鸣','子轩','志远','浩然']; const females=['美琳','可欣','语桐','嘉怡','若兰','欣怡']; const rnd=a=>a[Math.floor(Math.random()*a.length)];
      let g=Math.random()<.5?'male':'female'; let base=(g==='male'?rnd(males):rnd(females))+Math.floor(Math.random()*90+10);
      const finalNick=await claimNicknameAuto(base, me.uid);
      await setDoc(userRef, { uid:me.uid, nickname:finalNick, gender:g, createdAt:serverTimestamp(), lastSeenAt:serverTimestamp(), roles:['user'], blocked:false }, {merge:true});
      me.nickname=finalNick; me.gender=g;
    }
    el.meNick.textContent='@'+me.nickname; el.meNick.className=nameClass(me.uid, me.gender); el.meRole.textContent='user';

    // 白名单（管理员）
    onSnapshot(doc(db,'meta','admins'), snap=>{
      adminUIDs = Array.isArray(snap.data()?.uids) ? snap.data().uids : [];
      amAdmin = adminUIDs.includes(me.uid);
      el.meRole.textContent = amAdmin ? 'admin' : 'user';
      el.adminBar.style.display = amAdmin ? 'flex' : 'none';
      // 登录行隐藏/退出行显示：要求“是白名单管理员且以密码方式登录”
      const isPassword = (auth.currentUser?.providerData||[]).some(p=>p.providerId==='password');
      el.adminLoginRow.style.display = (amAdmin && isPassword) ? 'none' : 'flex';
      el.adminLogoutRow.style.display = (amAdmin && isPassword) ? 'flex' : 'none';
    });

    // 公聊
    onSnapshot(query(collection(db,'messages'), orderBy('createdAt','asc')), snap=>{
      snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('pub-'+ch.doc.id, ch.doc.data()); });
      renderFeed();
    });

    // 私聊订阅（默认：只订阅包含我；管理员模式：订阅全部）
    function subDm(){
      if (unsubDm) unsubDm();
      if (amAdmin && el.adminAll.checked){
        unsubDm = onSnapshot(query(collection(db,'dm'), orderBy('createdAt','asc')), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }else{
        unsubDm = onSnapshot(query(collection(db,'dm'), where('parties','array-contains', me.uid)), snap=>{
          snap.docChanges().forEach(ch=>{ if(ch.type==='added'||ch.type==='modified') feed.set('dm-'+ch.doc.id, ch.doc.data()); });
          renderFeed();
        });
      }
    }
    el.adminAll?.addEventListener('change', ()=>{ if(!amAdmin){ el.adminAll.checked=false; return;} subDm(); });
    subDm();

    // 在线用户（真实）
    onSnapshot(query(collection(db,'users'), orderBy('createdAt','asc')), s=>{
      const arr=[]; s.forEach(d=> arr.push({ ...d.data(), uid:d.id })); renderUsers(arr);
    });

    setStatus('ok','已就绪');
  });

  window.addEventListener('online', ()=>setStatus('ok','网络已恢复'));
  window.addEventListener('offline', ()=>setStatus('err','网络不可用'));

  // 保存档案
  $('saveProfile').onclick = async ()=>{
    const desired=el.nickInput.value.trim(); const gender=el.genderInput.value||'unset';
    let finalName=me.nickname;
    if(desired && desired!==me.nickname) finalName=await claimNicknameAuto(desired, me.uid);
    try{
      await setDoc(doc(db,'users',me.uid), { uid:me.uid, nickname:finalName, gender, lastSeenAt:serverTimestamp(), roles:me.roles||['user'], blocked:false }, {merge:true});
      me.nickname=finalName; me.gender=gender; el.meNick.textContent='@'+me.nickname; el.meNick.className=nameClass(me.uid, me.gender); updateSendTo();
    }catch(_){}
  };
</script>
</body>
</html>
